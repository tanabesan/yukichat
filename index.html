<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ゆきちゃっと</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        :root {
            --bg-31: #313338; --bg-2b: #2b2d31; --bg-38: #383a40;
            --txt: #dbdee1; --txt-m: #949ba4; --accent: #5865f2;
            --danger: #ed4245; --success: #3ba55c; --warning: #f1c40f;
            --friend-gold: #faa61a; --sidebar-w: 260px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; height: 100dvh;
            background: var(--bg-31); color: var(--txt); 
            overflow-x: hidden;
            overflow-y: hidden;
            overscroll-behavior: none;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        #app-wrapper, .responsive-card, .modal-overlay > * {
            max-width: 100%;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }

        .op-btn, .btn-sm, .sidebar-item, button, #sendBtn, .stamp-item {
            transition: transform 0.1s, opacity 0.1s;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        .op-btn:active, .btn-sm:active, .sidebar-item:active, button:active, #sendBtn:active, .stamp-item:active {
            transform: scale(0.92);
            opacity: 0.7;
        }

        .drag-over {
            outline: 3px dashed var(--accent);
            outline-offset: -10px;
            background-color: rgba(88, 101, 242, 0.1) !important;
        }

        /* --- サイドバー --- */
        #sidebar {
            position: fixed; top: 0; left: calc(-1 * var(--sidebar-w)); 
            width: var(--sidebar-w); height: 100%; background: var(--bg-2b);
            transition: transform 0.3s ease; z-index: 3000; display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            padding-bottom: env(safe-area-inset-bottom);
        }
        #sidebar.open { transform: translateX(var(--sidebar-w)); }
        #sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 2999; display: none;
        }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        .sidebar-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px; 
            border-radius: 5px; cursor: pointer; transition: 0.2s; margin-bottom: 2px;
        }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); }
        .sidebar-item.active { background: var(--bg-38); color: #fff; }
        .sidebar-label { font-size: 11px; color: var(--txt-m); margin: 15px 10px 5px; text-transform: uppercase; }

        /* --- メインレイアウト --- */
        #app-wrapper { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: 100dvh;
            width: 100%;
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        #app-wrapper.visible { opacity: 1; }

        header { 
            background: var(--bg-2b); padding: 10px 15px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #222; 
            z-index: 100; height: 48px; flex-shrink: 0; box-sizing: border-box; 
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        .header-left { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; }
        .menu-btn { cursor: pointer; display: flex; align-items: center; position: relative; }

        /* --- 未読バッジ用スタイル --- */
        .badge-notify::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-2b);
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(237, 66, 69, 0.7); }
            70% { transform: scale(1.2); box-shadow: 0 0 0 4px rgba(237, 66, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(237, 66, 69, 0); }
        }
        
        /* 設定ボタン用スタイル */
        .btn-toggle-on { background: var(--success) !important; }
        .btn-toggle-off { background: #4e5058 !important; }

        .icon-container { position: relative; display: inline-block; flex-shrink: 0; }
        .status-dot {
            position: absolute; 
            bottom: 0px; 
            right: 0px;
            width: 16px; 
            height: 16px; 
            border-radius: 50%;
            border: 3px solid var(--bg-31);
            z-index: 10;
        }
        .online { background-color: #00ff00; }
        .offline { background-color: #666; }
        
        /* DM未読バッジ */
        .dm-unread-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 10px;
            padding: 2px 6px;
            min-width: 18px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* --- 通話エリア --- */
        #call-overlay { background: #000; z-index: 50; display: flex; flex-direction: column; border-bottom: 2px solid var(--accent); flex-shrink: 0; }
        .video-container { height: 150px; display: flex; background: #111; gap: 1px; }
        #remoteVideo { flex: 1; height: 100%; object-fit: cover; }
        #localVideo { width: 100px; height: 100%; object-fit: cover; border-left: 2px solid #333; }
        .call-controls { padding: 8px; display: flex; justify-content: center; gap: 15px; background: var(--bg-2b); }
        .ctrl-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; background: #4e5058; }
        .ctrl-btn.off { background: var(--danger); }
        .ctrl-btn.hangup { background: var(--danger); width: 46px; }

        /* --- メッセージエリア --- */
        #messages-container { 
            position: relative; 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            min-height: 0;
            width: 100%;
        }
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch;
            width: 100%;
            box-sizing: border-box;
        }
        #typing-indicator { height: 20px; padding: 0 20px 5px; font-size: 12px; color: var(--txt-m); font-style: italic; }

        .message {
            display: flex; 
            gap: 10px; 
            align-items: flex-start; 
            max-width: 90%; 
            position: relative;
            box-sizing: border-box;
            min-width: 0;
        }
        .message.me { 
            flex-direction: row-reverse; 
            align-self: flex-end; 
        }
        .message .icon { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; cursor: pointer; background: #4e5058; }
        
        .message .msg-body { flex: 0 1 auto; min-width: 0; display: flex; flex-direction: column; }
        .message.me .msg-body { align-items: flex-end; }

        .message .user-info { font-size: 11px; color: var(--txt-m); margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .message.me .user-info { flex-direction: row-reverse; }

        .message .bubble { 
            padding: 8px 12px; 
            border-radius: 12px; 
            background: #4e5058; 
            font-size: 15px; 
            line-height: 1.4; 
            word-break: break-word;
            overflow-wrap: break-word;
            position: relative; 
            display: inline-block;
            color: #fff;
            width: fit-content;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .message.me .bubble { background: var(--accent); }

        .message:not(.me) .bubble::before { 
            content: ""; position: absolute; top: 10px; left: -8px; 
            border-top: 8px solid transparent; border-bottom: 8px solid transparent; 
            border-right: 10px solid #4e5058; 
        }
        .message.me .bubble::after { 
            content: ""; position: absolute; top: 10px; right: -8px; 
            border-top: 8px solid transparent; border-bottom: 8px solid transparent; 
            border-left: 10px solid var(--accent); 
        }

        .edited-mark { font-size: 10px; opacity: 0.6; margin-left: 5px; }
        .message.is-stamp .bubble { background: transparent !important; border: none !important; padding: 0; }
        .message.is-stamp .bubble::before, .message.is-stamp .bubble::after { display: none; }
        .message.is-friend .user-info::after { content: "FRIEND"; font-size: 9px; background: var(--friend-gold); color: #000; padding: 1px 4px; border-radius: 3px; font-weight: bold; margin-left: 5px; }

        .sent-img { 
            display: block; 
            margin-top: 8px; 
            border-radius: 8px; 
            max-width: 100%; 
            max-height: 250px; 
            cursor: pointer;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        .stamp-display { 
            display: block; 
            width: 140px; 
            height: 140px; 
            max-width: 100%;
            object-fit: contain; 
        }
        .reply-in-bubble { display: inline-block; background: rgba(0,0,0,0.15); padding: 4px 8px; margin-bottom: 6px; border-radius: 6px; font-size: 12px; cursor: pointer; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .msg-ops { display: flex; gap: 8px; margin-top: 6px; align-items: center; flex-wrap: wrap; }
        .message.me .msg-ops { justify-content: flex-end; }
        .msg-ops .op-btn { opacity: 0; transition: 0.1s; font-size: 18px; color: var(--txt-m); cursor: pointer; }
        .message:hover .msg-ops .op-btn { opacity: 1; }
        
        .reaction-badge { 
            background: var(--bg-2b); 
            border: 1px solid transparent; 
            border-radius: 8px; 
            padding: 4px 8px; 
            font-size: 14px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 4px;
            will-change: transform; /* パフォーマンス最適化 */
        }
        .reaction-badge.active { border-color: var(--accent); background: rgba(88,101,242,0.2); }

        /* --- アイテムバッジ --- */
        .user-badge {
            display: inline-block;
            font-size: 14px;
            margin-left: 4px;
            vertical-align: middle;
            animation: badgePulse 2s ease-in-out infinite;
            will-change: transform; /* パフォーマンス最適化 */
        }
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* --- スロットマシン --- */
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0.3; }
        }
        
        @keyframes reachPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
        }

        .slot-reel-container {
            width: 120px;
            height: 150px;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 50%, rgba(255,255,255,0.1) 100%);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .slot-reel {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .slot-symbols-strip {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            transition: none;
        }

        .slot-symbols-strip.spinning {
            animation: none;
        }

        .slot-symbol-item {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            user-select: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .slot-spin-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: #fff;
            border: 4px solid #ffd700;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255,0,0,0.6), inset 0 -3px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            overflow: hidden;
        }

        .slot-spin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255,0,0,0.8), inset 0 -3px 10px rgba(0,0,0,0.3);
        }

        .slot-spin-btn:active {
            transform: translateY(2px);
            box-shadow: 0 4px 15px rgba(255,0,0,0.4), inset 0 3px 10px rgba(0,0,0,0.5);
        }

        .slot-spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .bet-btn.active {
            border-color: #ffd700 !important;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        @keyframes shimmer {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 255, 255, 0.8); }
        }

        /* --- テーマ適用 --- */
        body.rainbow-theme {
            background: linear-gradient(45deg, #ff6b6b, #f093fb, #4facfe, #43e97b, #feca57, #ff6b6b);
            background-size: 400% 400%;
            animation: rainbowMove 10s ease infinite;
            will-change: background-position; /* パフォーマンス最適化 */
        }
        @keyframes rainbowMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body.rainbow-theme #app-wrapper { background: rgba(49, 51, 56, 0.95); }

        body.heart-theme {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        body.heart-theme #app-wrapper { background: rgba(49, 51, 56, 0.95); }
        body.heart-theme .bubble { background: rgba(245, 87, 108, 0.2) !important; border: 1px solid rgba(245, 87, 108, 0.3); }

        /* --- メッセージエフェクト --- */
        /* アイコンにエフェクトを適用 */
        .message.effect-fire .icon-container {
            position: relative;
            animation: iconShake 3s ease-in-out infinite;
            will-change: transform; /* パフォーマンス最適化 */
        }
        .message.effect-fire .icon-container .icon {
            box-shadow: 
                0 0 0 3px #ff6b6b,
                0 0 15px rgba(255, 107, 107, 0.6),
                0 0 25px rgba(255, 107, 107, 0.4);
            animation: fireIconGlow 3s ease infinite;
            will-change: box-shadow; /* パフォーマンス最適化 */
        }
        .message.effect-fire .icon-container::before {
            content: '🔥';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 20px;
            animation: fireFloat 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.8));
        }
        @keyframes fireIconGlow {
            0% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 15px rgba(255, 107, 107, 0.6), 0 0 25px rgba(255, 107, 107, 0.4); }
            33% { box-shadow: 0 0 0 3px #ff8e53, 0 0 15px rgba(255, 142, 83, 0.6), 0 0 25px rgba(255, 142, 83, 0.4); }
            66% { box-shadow: 0 0 0 3px #c92a2a, 0 0 15px rgba(201, 42, 42, 0.6), 0 0 25px rgba(201, 42, 42, 0.4); }
            100% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 15px rgba(255, 107, 107, 0.6), 0 0 25px rgba(255, 107, 107, 0.4); }
        }
        @keyframes iconShake {
            0%, 100% { transform: rotate(0deg); }
            2% { transform: rotate(2deg); }
            4% { transform: rotate(-2deg); }
            6% { transform: rotate(0deg); }
        }
        @keyframes fireFloat {
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-8px) scale(1.2); opacity: 0.8; }
        }

        .message.effect-sparkle .icon-container {
            position: relative;
        }
        .message.effect-sparkle .icon-container .icon {
            box-shadow: 
                0 0 0 3px #ffd700,
                0 0 20px rgba(255, 215, 0, 0.7),
                0 0 35px rgba(255, 215, 0, 0.5);
            animation: sparkleIconGlow 3s ease infinite;
        }
        .message.effect-sparkle .icon-container::before {
            content: '✨';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 20px;
            animation: sparkleFloat 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes sparkleIconGlow {
            0% { box-shadow: 0 0 0 3px #ffd700, 0 0 20px rgba(255, 215, 0, 0.7), 0 0 35px rgba(255, 215, 0, 0.5); }
            33% { box-shadow: 0 0 0 3px #ffed4e, 0 0 25px rgba(255, 237, 78, 0.8), 0 0 40px rgba(255, 237, 78, 0.6); }
            66% { box-shadow: 0 0 0 3px #f59f00, 0 0 20px rgba(245, 159, 0, 0.7), 0 0 35px rgba(245, 159, 0, 0.5); }
            100% { box-shadow: 0 0 0 3px #ffd700, 0 0 20px rgba(255, 215, 0, 0.7), 0 0 35px rgba(255, 215, 0, 0.5); }
        }
        @keyframes sparkleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-8px) rotate(180deg); opacity: 0.7; }
        }

        .message.effect-lightning .icon-container {
            position: relative;
        }
        .message.effect-lightning .icon-container .icon {
            box-shadow: 
                0 0 0 3px #4dabf7,
                0 0 15px rgba(77, 171, 247, 0.6),
                0 0 25px rgba(77, 171, 247, 0.4);
            animation: lightningIconGlow 2.5s ease infinite;
        }
        .message.effect-lightning .icon-container::before {
            content: '⚡';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: lightningBolt 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(77, 171, 247, 1));
        }
        @keyframes lightningIconGlow {
            0%, 100% { box-shadow: 0 0 0 3px #4dabf7, 0 0 15px rgba(77, 171, 247, 0.6), 0 0 25px rgba(77, 171, 247, 0.4); }
            25% { box-shadow: 0 0 0 3px #748ffc, 0 0 15px rgba(116, 143, 252, 0.6), 0 0 25px rgba(116, 143, 252, 0.4); }
            50% { box-shadow: 0 0 0 3px #339af0, 0 0 15px rgba(51, 154, 240, 0.6), 0 0 25px rgba(51, 154, 240, 0.4); }
            75% { box-shadow: 0 0 0 3px #748ffc, 0 0 15px rgba(116, 143, 252, 0.6), 0 0 25px rgba(116, 143, 252, 0.4); }
            85%, 90% { box-shadow: 0 0 0 4px #ffffff, 0 0 30px rgba(255, 255, 255, 1), 0 0 50px rgba(77, 171, 247, 0.8); }
        }
        @keyframes lightningBolt {
            0%, 90%, 100% { transform: scale(1); opacity: 1; }
            92% { transform: scale(1.3); opacity: 1; }
            94% { transform: scale(0.8); opacity: 0.5; }
        }

        /* 虹色エフェクト */
        .message.effect-rainbow .icon-container {
            position: relative;
            animation: iconShake 3s ease-in-out infinite;
            will-change: transform;
        }
        .message.effect-rainbow .icon-container .icon {
            box-shadow: 0 0 0 3px #ff6b6b, 0 0 15px rgba(255, 107, 107, 0.6), 0 0 25px rgba(255, 107, 107, 0.4);
            animation: rainbowIconGlow 4s ease infinite;
            will-change: box-shadow;
        }
        .message.effect-rainbow .icon-container::before {
            content: '🌟';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: sparkleFloat 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes rainbowIconGlow {
            0% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.8); }
            20% { box-shadow: 0 0 0 3px #ffd93d, 0 0 20px rgba(255, 217, 61, 0.8); }
            40% { box-shadow: 0 0 0 3px #6bcf7f, 0 0 20px rgba(107, 207, 127, 0.8); }
            60% { box-shadow: 0 0 0 3px #4dabf7, 0 0 20px rgba(77, 171, 247, 0.8); }
            80% { box-shadow: 0 0 0 3px #a78bfa, 0 0 20px rgba(167, 139, 250, 0.8); }
            100% { box-shadow: 0 0 0 3px #ff6b6b, 0 0 20px rgba(255, 107, 107, 0.8); }
        }

        /* シャドウエフェクト */
        .message.effect-shadow .icon-container {
            position: relative;
            animation: shadowPulse 3s ease-in-out infinite;
        }
        .message.effect-shadow .icon-container .icon {
            box-shadow: 0 0 0 3px #2d3436, 0 0 20px rgba(0, 0, 0, 0.9), 0 0 40px rgba(139, 69, 255, 0.5);
            animation: shadowGlow 3s ease infinite;
        }
        .message.effect-shadow .icon-container::before {
            content: '🌑';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: shadowFloat 2.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes shadowGlow {
            0%, 100% { box-shadow: 0 0 0 3px #2d3436, 0 0 20px rgba(0, 0, 0, 0.9), 0 0 40px rgba(139, 69, 255, 0.5); }
            50% { box-shadow: 0 0 0 4px #000000, 0 0 30px rgba(0, 0, 0, 1), 0 0 60px rgba(139, 69, 255, 0.8); }
        }
        @keyframes shadowPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shadowFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-10px) rotate(180deg); opacity: 1; }
        }

        /* 氷エフェクト */
        .message.effect-ice .icon-container {
            position: relative;
        }
        .message.effect-ice .icon-container .icon {
            box-shadow: 0 0 0 3px #74c0fc, 0 0 15px rgba(116, 192, 252, 0.8), 0 0 25px rgba(173, 232, 255, 0.6);
            animation: iceGlow 3s ease infinite;
        }
        .message.effect-ice .icon-container::before {
            content: '❄️';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: iceRotate 4s linear infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes iceGlow {
            0%, 100% { box-shadow: 0 0 0 3px #74c0fc, 0 0 15px rgba(116, 192, 252, 0.8), 0 0 25px rgba(173, 232, 255, 0.6); }
            50% { box-shadow: 0 0 0 4px #d0ebff, 0 0 25px rgba(208, 235, 255, 1), 0 0 40px rgba(116, 192, 252, 0.8); }
        }
        @keyframes iceRotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* 毒エフェクト */
        .message.effect-toxic .icon-container {
            position: relative;
            animation: toxicShake 2s ease-in-out infinite;
        }
        .message.effect-toxic .icon-container .icon {
            box-shadow: 0 0 0 3px #9b59b6, 0 0 15px rgba(155, 89, 182, 0.8), 0 0 25px rgba(142, 68, 173, 0.6);
            animation: toxicGlow 2.5s ease infinite;
        }
        .message.effect-toxic .icon-container::before {
            content: '☠️';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: toxicBubble 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes toxicGlow {
            0%, 100% { box-shadow: 0 0 0 3px #9b59b6, 0 0 15px rgba(155, 89, 182, 0.8), 0 0 25px rgba(142, 68, 173, 0.6); }
            50% { box-shadow: 0 0 0 4px #8e44ad, 0 0 25px rgba(142, 68, 173, 1), 0 0 40px rgba(155, 89, 182, 0.9); }
        }
        @keyframes toxicShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        @keyframes toxicBubble {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
            50% { transform: translateY(-12px) scale(1.3); opacity: 1; }
        }

        /* ゴールドエフェクト */
        .message.effect-gold .icon-container {
            position: relative;
        }
        .message.effect-gold .icon-container .icon {
            box-shadow: 0 0 0 4px #ffd700, 0 0 20px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8);
            animation: goldShine 3s ease infinite;
        }
        .message.effect-gold .icon-container::before {
            content: '💛';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: goldPulse 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 1));
        }
        @keyframes goldShine {
            0%, 100% { box-shadow: 0 0 0 4px #ffd700, 0 0 20px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 0 5px #ffed4e, 0 0 35px rgba(255, 237, 78, 1), 0 0 60px rgba(255, 215, 0, 1); }
        }
        @keyframes goldPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2) rotate(15deg); opacity: 0.9; }
        }

        /* --- 入力エリア --- */
        .input-area-container { 
            background: var(--bg-2b); border-top: 1px solid #222; width: 100%; flex-shrink: 0; transition: 0.2s; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        #reply-preview, #edit-indicator { background: var(--bg-38); padding: 8px 15px; display: flex; justify-content: space-between; font-size: 12px; border-left: 4px solid var(--accent); }
        #edit-indicator { border-left-color: var(--warning); }
        #upload-preview-container { padding: 10px; background: var(--bg-38); display: flex; align-items: center; gap: 10px; }
        #upload-status-indicator, #profile-upload-status { background: var(--bg-38); padding: 5px 15px; color: var(--accent); font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; border-radius: 4px; margin-bottom: 10px; }
        .dot-ani { animation: blink 1.4s infinite both; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }

        .input-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 10px; 
            box-sizing: border-box;
            width: 100%;
        }
        #my-profile-trigger { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; max-width: 140px; overflow: hidden; flex-shrink: 0; }
        #my-profile-trigger:active { background: rgba(255,255,255,0.1); }
        #myName { font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #messageInput { flex: 1; background: var(--bg-38); border: none; padding: 10px 12px; border-radius: 20px; color: var(--txt); outline: none; resize: none; font-size: 16px; max-height: 120px; box-sizing: border-box; min-width: 0; }
        
        /* オンラインバッジサイズ調整 */
        /* オンラインバッジサイズ（統一） */
        .status-dot {
            width: 16px !important;
            height: 16px !important;
            border-radius: 50%;
            position: absolute;
            bottom: 0px;
            right: 0px;
            border: 3px solid var(--bg-2b);
            z-index: 10;
        }
        .status-dot.online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .status-dot.offline { background: #666; }
        
        /* サイドバー（DMリスト）専用: 小さめ */
        .sidebar-item .status-dot {
            width: 10px !important;
            height: 10px !important;
            border: 2px solid var(--bg-2b);
            bottom: 0px;
            right: 0px;
        }
        .sidebar-item .status-dot.online { 
            background: #00ff00; 
            box-shadow: 0 0 4px #00ff00; 
        }
        
        /* --- モーダル共通 --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
        
        .responsive-card {
            background: var(--bg-31);
            border-radius: 12px;
            width: 100%;
            max-width: 360px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .prof-card { width: 100%; max-width: 320px; background: #111214; border-radius: 12px; overflow: hidden; position: relative; margin: auto; }
        .prof-banner { height: 80px; width: 100%; object-fit: cover; background: var(--accent); }
        .prof-avatar { width: 64px; height: 64px; border-radius: 50%; border: 4px solid #111214; position: absolute; top: 48px; left: 16px; background: #333; }
        
        /* プロフィールモーダルのエフェクト対応 */
        .prof-card .effect-fire .icon-container,
        .prof-card .effect-sparkle .icon-container,
        .prof-card .effect-lightning .icon-container,
        .prof-card .effect-rainbow .icon-container,
        .prof-card .effect-shadow .icon-container,
        .prof-card .effect-ice .icon-container,
        .prof-card .effect-toxic .icon-container,
        .prof-card .effect-gold .icon-container {
            position: relative;
        }
        
        .prof-card .effect-fire .icon { animation: fireIconGlow 3s ease infinite; }
        .prof-card .effect-sparkle .icon { animation: sparkleIconGlow 3s ease infinite; }
        .prof-card .effect-lightning .icon { animation: lightningIconGlow 3s ease infinite; }
        .prof-card .effect-rainbow .icon { animation: rainbowIconGlow 4s ease infinite; }
        .prof-card .effect-shadow .icon { animation: shadowGlow 3s ease infinite; }
        .prof-card .effect-ice .icon { animation: iceGlow 3s ease infinite; }
        .prof-card .effect-toxic .icon { animation: toxicGlow 2.5s ease infinite; }
        .prof-card .effect-gold .icon { animation: goldShine 3s ease infinite; }
        
        /* エフェクト絵文字も表示 */
        .prof-card .effect-fire .icon-container::before {
            content: '🔥';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 20px;
            animation: fireFloat 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-sparkle .icon-container::before {
            content: '✨';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 20px;
            animation: sparkleFloat 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-lightning .icon-container::before {
            content: '⚡';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: lightningBolt 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-rainbow .icon-container::before {
            content: '🌟';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: sparkleFloat 3s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-shadow .icon-container::before {
            content: '🌑';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: shadowFloat 2.5s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-ice .icon-container::before {
            content: '❄️';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: iceRotate 4s linear infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-toxic .icon-container::before {
            content: '☠️';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: toxicBubble 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .prof-card .effect-gold .icon-container::before {
            content: '💛';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 22px;
            animation: goldPulse 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 10;
        }
        .settings-input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #444; background:#1e1f22; color:#fff; box-sizing: border-box; font-size: 16px; }
        
        .settings-input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .settings-input-group .settings-input { margin-bottom: 0; flex: 1; }
        .btn-upload-small { background: var(--accent); color: #fff; border: none; border-radius: 5px; padding: 0 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; color: var(--txt-m); cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid var(--accent); }
        .user-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; background: var(--bg-38); padding: 10px; border-radius: 8px; }
        .btn-sm { padding: 6px 12px; border-radius: 4px; border: none; color: #fff; cursor: pointer; font-size: 12px; font-weight: bold; margin-left: 5px; }

        #init-loader { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: var(--bg-31); z-index: 9999; }
        .preview-box { border: 1px solid #444; border-radius: 8px; overflow: hidden; margin-bottom: 15px; background: #111; padding-bottom: 10px; }
        .preview-label { font-size: 10px; color: var(--txt-m); padding: 5px 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .stamp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .stamp-item { width: 100%; aspect-ratio: 1/1; cursor: pointer; border-radius: 8px; transition: 0.2s; object-fit: contain; }

        #load-more-indicator { text-align: center; padding: 10px; font-size: 12px; color: var(--txt-m); }

        .avatar-edit-overlay {
            position: absolute; top: 48px; left: 16px; width: 64px; height: 64px;
            border-radius: 50%; background: rgba(0,0,0,0.4); display: flex;
            align-items: center; justify-content: center; color: #fff; cursor: pointer;
            border: 4px solid #111214; z-index: 10; opacity: 0; transition: 0.2s;
        }
        .avatar-edit-overlay:hover { opacity: 1; }
        .banner-edit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            color: #fff; cursor: pointer; opacity: 0; transition: 0.2s;
        }
        .banner-edit-overlay:hover { opacity: 1; }

        @media screen and (max-width: 600px) {
            #myName { display: none; }
            #my-profile-trigger { padding: 0; }
            .input-wrapper { gap: 6px; padding: 6px 8px; }
            #messageInput { padding: 8px 10px; font-size: 16px; }
            #sendBtn { width: 32px; height: 32px; }
            .stamp-grid { grid-template-columns: repeat(3, 1fr); }
            .msg-ops .op-btn { opacity: 0.6; }
            .prof-card, .responsive-card { width: 95%; }
            .header-left { font-size: 14px; }
            
            /* スマホ: プロフ編集を1カラムに */
            #settings-modal .responsive-card > div {
                grid-template-columns: 1fr !important;
            }
            #settings-modal .preview-box {
                position: static !important;
            }
        }
    </style>
</head>
<body id="body-container">

    <div id="init-loader"><div>Loading...</div></div>

    <div id="auth-container" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:30px; text-align:center; max-width: 320px;">
            <h2>ゆきちゃっと</h2>
            <input type="email" id="email" class="settings-input" placeholder="メール">
            <input type="password" id="password" class="settings-input" placeholder="パスワード">
            <button id="loginBtn" style="width:100%; padding:12px; background:var(--accent); color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; font-size:16px;">ログイン / 登録</button>
            
            <div style="margin: 15px 0; border-top: 1px solid #444;"></div>
            
            <button id="guestBtn" style="width:100%; padding:12px; background:#4e5058; color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; font-size:16px;">ゲストで参加 (匿名)</button>
            <div style="font-size:11px; color:var(--txt-m); margin-top:5px;">※ゲストは最終ログインから30日後に自動削除されます</div>
        </div>
    </div>

    <div id="sidebar-overlay"></div>
    <div id="sidebar">
        <div class="sidebar-header">
            <span>メニュー</span>
            <span class="material-symbols-outlined op-btn" onclick="toggleSidebar(false)">close</span>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-item active" onclick="switchChat(null); toggleSidebar(false);">
                <span class="material-symbols-outlined">public</span>
                <span>パブリックチャット</span>
            </div>
            <div class="sidebar-item" onclick="$('#user-list-modal').removeClass('hidden'); toggleSidebar(false); switchUserTab('all');">
                <span class="material-symbols-outlined">person_search</span>
                <span>ユーザーを探す</span>
            </div>
            
            <div class="sidebar-label">ダイレクトメッセージ</div>
            <div id="dm-list"></div>
        </div>
        <div style="padding: 15px; border-top: 1px solid #222;">
            <div class="sidebar-item" id="logoutBtnSide" style="color: var(--danger);">
                <span class="material-symbols-outlined">logout</span>
                <span>ログアウト</span>
            </div>
        </div>
    </div>

    <div id="app-wrapper">
        <header>
            <div class="header-left">
                <span id="menuToggle" class="material-symbols-outlined menu-btn" style="padding:5px;">menu</span>
                <span id="headerTitle">パブリックチャット</span>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <span id="openSlotBtn" class="material-symbols-outlined op-btn" style="color:#ff4757; opacity:1; font-size:24px;" title="スロット">casino</span>
                <span id="openLoginBonusBtn" class="material-symbols-outlined op-btn" style="color:#ffd700; opacity:1; font-size:24px;" title="ログインボーナス">redeem</span>
                <span id="openShopBtnHeader" class="material-symbols-outlined op-btn" style="color:#f093fb; opacity:1; font-size:24px;" title="ショップ">shopping_bag</span>
                <span id="openOtherSettings" class="material-symbols-outlined op-btn" style="opacity:1;" title="設定">settings</span>
            </div>
        </header>

        <div id="call-overlay" class="hidden">
            <div class="video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
            <div class="call-controls">
                <button class="ctrl-btn off" id="toggleMic"><span class="material-symbols-outlined">mic_off</span></button>
                <button class="ctrl-btn off" id="toggleCam"><span class="material-symbols-outlined">videocam_off</span></button>
                <button class="ctrl-btn hangup" id="hangupBtn"><span class="material-symbols-outlined">call_end</span></button>
            </div>
        </div>

        <div id="messages-container">
            <!-- 名前変更を促すバナー -->
            <div id="guest-warning-banner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 15px; text-align: center; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative; z-index: 50;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <span style="flex: 1 1 auto; min-width: 200px;">👋 ゲストモードではフレンド機能が使えません。名前を変更するか、メールアドレスでログインしてください！</span>
                    <button onclick="$('#my-profile-trigger').click(); $('#guest-warning-banner').hide();" style="background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">設定へ</button>
                    <button onclick="$('#guest-warning-banner').hide();" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; padding: 0 5px; opacity: 0.8; line-height: 1;">✕</button>
                </div>
            </div>
            
            <div id="messages"></div>
            <div id="typing-indicator" class="hidden"></div>
        </div>

        <div id="chat-input-area" class="input-area-container">
            <div id="reply-preview" class="hidden">
                <div style="overflow:hidden; text-overflow:ellipsis;">返信先: <span id="reply-user-p" style="font-weight:bold; color:var(--accent);"></span></div>
                <span id="cancel-reply" class="material-symbols-outlined op-btn" style="font-size:16px; opacity:1;">close</span>
            </div>
            <div id="edit-indicator" class="hidden">
                <div style="overflow:hidden; text-overflow:ellipsis;">メッセージを編集モード</div>
                <span id="cancel-edit" class="material-symbols-outlined op-btn" style="font-size:16px; opacity:1;">close</span>
            </div>
            <div id="upload-status-indicator" class="hidden">
                アップロード中<span class="dot-ani">.</span><span class="dot-ani">.</span><span class="dot-ani">.</span>
            </div>
            <div id="upload-preview-container" class="hidden">
                <div style="position:relative;">
                    <img id="img-preview-src" src="" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                    <div id="remove-img-btn" style="position:absolute; top:-5px; right:-5px; background:var(--danger); border-radius:50%; width:16px; height:16px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:10px;">×</div>
                </div>
            </div>
            <div class="input-wrapper">
                <div id="my-profile-trigger" title="プロフィールを編集">
                    <div id="myIconContainer"></div>
                    <span id="myName"></span>
                </div>
                <span id="imgBtn" class="material-symbols-outlined op-btn" style="opacity:1;" title="画像をアップロード">add_circle</span>
                <input type="file" id="real_file_input" class="hidden" accept="image/*">
                <textarea id="messageInput" placeholder="メッセージ" rows="1"></textarea>
                <span id="stampBtn" class="material-symbols-outlined op-btn" style="opacity:1; cursor:pointer;" title="スタンプ">mood</span>
                <button id="sendBtn" style="background:var(--accent); color:#fff; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center;">
                    <span class="material-symbols-outlined" style="font-size:20px;">send</span>
                </button>
            </div>
        </div>
    </div>

    <div id="stamp-modal" class="modal-overlay hidden" onclick="$(this).addClass('hidden')">
        <div class="responsive-card" style="padding:20px; max-width:300px;" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">スタンプを選択</h3>
            <div id="stamp-list" class="stamp-grid"></div>
            <button onclick="$('#stamp-modal').addClass('hidden')" style="width:100%; background:none; color:var(--txt-m); border:none; margin-top:10px; cursor:pointer; padding:10px;">キャンセル</button>
        </div>
    </div>

    <div id="prof-modal" class="modal-overlay hidden" onclick="$(this).addClass('hidden')">
        <div class="prof-card" onclick="event.stopPropagation()">
            <img id="viewBanner" class="prof-banner" src="">
            <div style="padding:15px; padding-top:40px; color:#fff; position:relative;">
                <div class="icon-container" id="viewAvatarContainer" style="position:absolute; top:-32px; left:16px; width:64px; height:64px;">
                    <img id="viewAvatar" class="icon" src="" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:4px solid #111214;">
                    <div id="viewStatusDot" class="status-dot offline"></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <div id="viewName" style="font-size:18px; font-weight:bold;"></div>
                        <div id="viewBadges" style="margin-top:5px;"></div>
                    </div>
                    <div id="prof-action-box"></div>
                </div>
                <div id="viewBio" style="font-size:13px; color:var(--txt); margin-top:10px; white-space:pre-wrap;"></div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:20px; max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-top:0;">プロフィール編集</h3>
            
            <!-- PC: 2カラムレイアウト -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- 左側: プレビュー -->
                <div>
                    <div class="preview-box" style="position: sticky; top: 0;">
                        <div class="preview-label">Live Preview</div>
                        <div class="prof-card" style="width: 100%; background: #18191c; max-width: 100%;">
                            <img id="editPreviewBanner" class="prof-banner" src="">
                            <div class="banner-edit-overlay" onclick="$('#real_banner_input').click()">
                                <span class="material-symbols-outlined">photo_camera</span>
                            </div>
                            <div style="padding:15px; padding-top:40px; position:relative;">
                                <div class="icon-container" id="editPreviewAvatarContainer" style="position:absolute; top:-32px; left:16px; width:64px; height:64px;">
                                    <img id="editPreviewAvatar" class="icon" src="" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:4px solid #18191c;">
                                    <div id="editPreviewStatusDot" class="status-dot online"></div>
                                </div>
                                <div id="editPreviewName" style="font-size:18px; font-weight:bold; color:#fff;"></div>
                                <div id="editPreviewBadge" style="margin-top:5px;"></div>
                                <div id="editPreviewBio" style="font-size:12px; color:var(--txt); margin-top:10px; white-space:pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側: フォーム -->
                <div>
                    <input type="file" id="real_avatar_input" class="hidden" accept="image/*">
                    <input type="file" id="real_banner_input" class="hidden" accept="image/*">

                    <label style="font-size:11px; color:var(--txt-m);">名前</label>
                    <input type="text" id="editName" class="settings-input" placeholder="名前" style="margin-bottom: 12px;">
                    
                    <label style="font-size:11px; color:var(--txt-m);">アイコンURL</label>
                    <div class="settings-input-group" style="margin-bottom: 12px;">
                        <input type="text" id="editPhoto" class="settings-input" placeholder="https://...">
                        <button type="button" class="btn-upload-small" onclick="$('#real_avatar_input').click()">
                            <span class="material-symbols-outlined" style="font-size:18px;">upload</span>
                        </button>
                    </div>

                    <label style="font-size:11px; color:var(--txt-m);">バナーURL</label>
                    <div class="settings-input-group" style="margin-bottom: 12px;">
                        <input type="text" id="editBanner" class="settings-input" placeholder="https://...">
                        <button type="button" class="btn-upload-small" onclick="$('#real_banner_input').click()">
                            <span class="material-symbols-outlined" style="font-size:18px;">upload</span>
                        </button>
                    </div>

                    <label style="font-size:11px; color:var(--txt-m);">自己紹介</label>
                    <textarea id="editBio" class="settings-input" placeholder="自己紹介" style="height:50px; margin-bottom: 15px;"></textarea>

                    <!-- アイテム装備設定 -->
                    <div style="padding-top:15px; border-top:1px solid var(--bg-38);">
                        <h4 style="margin:0 0 12px 0; color:var(--txt); font-size:14px;">🎨 アイテム設定</h4>
                        
                        <label style="font-size:11px; color:var(--txt-m); display:block; margin-bottom:3px;">バッジ</label>
                        <select id="editEquippedBadge" class="settings-input" style="margin-bottom:10px;">
                            <option value="">なし</option>
                        </select>

                        <label style="font-size:11px; color:var(--txt-m); display:block; margin-bottom:3px;">テーマ</label>
                        <select id="editEquippedTheme" class="settings-input" style="margin-bottom:10px;">
                            <option value="">デフォルト</option>
                        </select>

                        <label style="font-size:11px; color:var(--txt-m); display:block; margin-bottom:3px;">エフェクト</label>
                        <select id="editEquippedEffect" class="settings-input" style="margin-bottom:10px;">
                            <option value="">なし</option>
                        </select>
                    </div>

                    <div id="profile-upload-status" class="hidden" style="margin-top: 10px;">
                        <span id="profile-upload-text">画像をアップロード中</span><span class="dot-ani">.</span><span class="dot-ani">.</span><span class="dot-ani">.</span>
                    </div>

                    <button id="saveProfile" style="width:100%; padding:10px; background:var(--accent); color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; font-size:16px; margin-top: 10px;">保存して更新</button>
                    <button onclick="$('#settings-modal').addClass('hidden')" style="width:100%; background:none; color:var(--txt-m); border:none; margin-top:8px; cursor:pointer; padding:8px;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <div id="other-settings-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:25px; text-align:center; max-width: 300px;">
            <h3>設定</h3>

            <button id="toggleSoundBtn" class="btn-toggle-on" style="width:100%; padding:12px; color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; margin-bottom:10px; font-size:16px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <span class="material-symbols-outlined">volume_up</span>
                <span id="soundBtnText">通知音: ON</span>
            </button>

            <button id="toggleNotificationBtn" class="btn-toggle-on" style="width:100%; padding:12px; color:#fff; border:none; border-radius:5px; font-weight:bold; cursor:pointer; margin-bottom:10px; font-size:16px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <span class="material-symbols-outlined">notifications</span>
                <span id="notificationBtnText">通知: ON</span>
            </button>

            <button id="logoutBtn" style="width:100%; padding:12px; background:var(--danger); color:#fff; border:none; border-radius:5px; font-weight:bold; font-size:16px; margin-top:10px;">ログアウト</button>
            <button onclick="$('#other-settings-modal').addClass('hidden')" style="width:100%; background:none; color:var(--txt-m); border:none; margin-top:10px; cursor:pointer; padding:10px;">閉じる</button>
        </div>
    </div>

    <div id="user-list-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:20px; max-height:80vh; display:flex; flex-direction:column;">
            <h3 style="margin-top:0;">ユーザー</h3>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchUserTab('all')">すべて</button>
                <button class="tab-btn" onclick="switchUserTab('friends')">フレンド</button>
                <button class="tab-btn" onclick="switchUserTab('requests')">申請 <span id="request-count-badge" style="display:none; background:var(--danger); color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:5px;"></span></button>
            </div>
            <div id="user-list-container" style="flex:1; overflow-y:auto;"></div>
            <button onclick="$('#user-list-modal').addClass('hidden')" style="width:100%; background:none; color:var(--txt-m); border:none; margin-top:15px; cursor:pointer; padding:10px;">閉じる</button>
        </div>
    </div>

    <!-- 管理者権限テストモーダル -->
    <!-- スロットマシンモーダル -->
    <div id="slot-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:30px; text-align:center; max-width: 600px;">
            <h2 style="margin:10px 0 5px 0; font-family: 'Impact', sans-serif; color:#ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">🎰 LUCKY SLOT 🎰</h2>
            <div style="font-size:12px; color:var(--txt-m); margin-bottom:20px;">1 PLAY = 10 COINS</div>
            
            <!-- スロット台本体 -->
            <div style="background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); padding: 30px 20px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.8), inset 0 0 50px rgba(255,215,0,0.1); border: 4px solid #ffd700; position: relative;">
                
                <!-- 装飾ライト -->
                <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                    <div class="slot-light" style="width: 12px; height: 12px; border-radius: 50%; background: #ff0000; box-shadow: 0 0 10px #ff0000; animation: blink 1s infinite;"></div>
                    <div class="slot-light" style="width: 12px; height: 12px; border-radius: 50%; background: #00ff00; box-shadow: 0 0 10px #00ff00; animation: blink 1s infinite 0.33s;"></div>
                    <div class="slot-light" style="width: 12px; height: 12px; border-radius: 50%; background: #0000ff; box-shadow: 0 0 10px #0000ff; animation: blink 1s infinite 0.66s;"></div>
                    <div class="slot-light" style="width: 12px; height: 12px; border-radius: 50%; background: #ffff00; box-shadow: 0 0 10px #ffff00; animation: blink 1s infinite;"></div>
                    <div class="slot-light" style="width: 12px; height: 12px; border-radius: 50%; background: #ff00ff; box-shadow: 0 0 10px #ff00ff; animation: blink 1s infinite 0.33s;"></div>
                </div>

                <!-- リール窓 -->
                <div style="background: #000; padding: 25px 15px; border-radius: 15px; border: 3px solid #333; box-shadow: inset 0 0 30px rgba(0,0,0,0.9); margin-bottom: 20px; position: relative; overflow: hidden;">
                    
                    <!-- 中央ライン -->
                    <div style="position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: linear-gradient(90deg, transparent, #ffd700, transparent); transform: translateY(-50%); z-index: 10; box-shadow: 0 0 10px #ffd700;"></div>
                    
                    <div style="display:flex; gap:20px; justify-content:center;">
                        <!-- リール1 -->
                        <div class="slot-reel-container">
                            <div class="slot-reel" id="reel1">
                                <div class="slot-symbols-strip" id="strip1"></div>
                            </div>
                        </div>
                        <!-- リール2 -->
                        <div class="slot-reel-container">
                            <div class="slot-reel" id="reel2">
                                <div class="slot-symbols-strip" id="strip2"></div>
                            </div>
                        </div>
                        <!-- リール3 -->
                        <div class="slot-reel-container">
                            <div class="slot-reel" id="reel3">
                                <div class="slot-symbols-strip" id="strip3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- リーチ演出 -->
                <div id="reach-effect" class="hidden" style="font-size:28px; font-weight:bold; color:#ffd700; text-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700; animation: reachPulse 0.3s infinite; margin-bottom: 15px;">
                    🔥 REACH! 🔥
                </div>

                <!-- コイン表示 -->
                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); padding: 15px 20px; border-radius: 10px; border: 2px solid #444;">
                    <div style="text-align: left;">
                        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Credits</div>
                        <div id="slot-coins" style="font-size: 28px; font-weight: bold; color: #ffd700; font-family: 'Courier New', monospace; text-shadow: 0 0 10px #ffd700;">0000</div>
                    </div>
                    <div id="slot-result-display" class="hidden" style="text-align: right;">
                        <div style="font-size: 10px; color: #888; text-transform: uppercase;">Win</div>
                        <div id="slot-win-amount" style="font-size: 28px; font-weight: bold; color: #00ff00; font-family: 'Courier New', monospace; text-shadow: 0 0 10px #00ff00;">+0000</div>
                    </div>
                </div>
            </div>

            <!-- スペシャルスピン表示 -->
            <div id="special-spin-indicator" class="hidden" style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; animation: shimmer 1s infinite; border: 2px solid #fff;">
                <div style="font-size: 18px; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                    ✨ SPECIAL SPIN ACTIVE! ✨
                </div>
                <div style="font-size: 12px; color: #fff; margin-top: 5px;">Next payout x2</div>
            </div>

            <!-- 強化スピンインジケーター -->
            <div id="boosted-spins-indicator" class="hidden" style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); border-radius: 12px; border: 2px solid #ffd700; text-align: center; box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);">
                <div style="font-size: 20px; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                    🔥 BOOSTED SPINS 🔥
                </div>
                <div style="font-size: 12px; color: #fff; margin-top: 5px;">High win rate! (60%)</div>
            </div>

            <!-- ベット選択 -->
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 8px;">BET</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="bet-btn active" data-bet="1" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); color: #fff; border: 2px solid #ffd700; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                        ×1<br><span style="font-size: 10px;">10 COINS</span>
                    </button>
                    <button class="bet-btn" data-bet="10" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); color: #fff; border: 2px solid #666; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                        ×10<br><span style="font-size: 10px;">100 COINS</span>
                    </button>
                    <button class="bet-btn" data-bet="100" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); color: #fff; border: 2px solid #666; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
                        ×100<br><span style="font-size: 10px;">1000 COINS</span>
                    </button>
                </div>
            </div>

            <!-- スピンボタン -->
            <button id="spin-btn" class="slot-spin-btn">
                <div style="font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🎰 SPIN</div>
                <div id="spin-btn-cost" style="font-size: 12px; margin-top: 5px; opacity: 0.9;">- 10 COINS -</div>
            </button>
            
            <button onclick="$('#slot-modal').addClass('hidden')" style="width:100%; background:var(--bg-38); color:var(--txt); border:none; cursor:pointer; padding:12px; border-radius:8px; margin-top: 10px;">EXIT</button>

            <!-- 配当表 -->
            <div style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.5); border-radius:12px; border: 2px solid #333;">
                <div style="font-size:14px; font-weight:bold; margin-bottom:10px; color: #ffd700; text-transform: uppercase;">💰 Pay Table <span id="bet-multiplier-text" style="color: #fff;">(×1)</span></div>
                <div id="pay-table" style="font-size:12px; line-height:2; color:#ccc; font-family: 'Courier New', monospace;">
                    🍒🍒🍒 → ×5  ( 50)<br>
                    🍋🍋🍋 → ×8  ( 80)<br>
                    🍊🍊🍊 → ×12 (120)<br>
                    🍇🍇🍇 → ×20 (200)<br>
                    ⭐⭐⭐ → ×40 (400)<br>
                    💎💎💎 → ×100 (1000) + SPECIAL!<br>
                    🎁🎁🎁 → 🔥 BOOST x10 SPINS!
                </div>
            </div>
        </div>
    </div>

    <!-- ログインボーナスモーダル -->
    <div id="login-bonus-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:30px; text-align:center; max-width: 400px;">
            <div style="font-size:60px; margin-bottom:10px;">🎁</div>
            <h2 style="margin:10px 0;">ログインボーナス</h2>
            
            <div id="bonus-status" style="background:var(--bg-38); padding:20px; border-radius:12px; margin:20px 0;">
                <div style="font-size:14px; color:var(--txt-m); margin-bottom:10px;">本日のボーナス</div>
                <div id="bonus-amount" style="font-size:48px; font-weight:bold; color:#ffd700;">+100</div>
                <div style="font-size:16px; color:var(--txt-m); margin-top:5px;">コイン</div>
            </div>

            <div id="bonus-claim-section">
                <button id="claimBonusBtn" style="width:100%; padding:15px; background:linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:18px; margin-bottom:10px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);">
                    受け取る
                </button>
                <div style="font-size:12px; color:var(--txt-m);">※ 1日1回まで</div>
            </div>

            <div id="bonus-already-claimed" class="hidden" style="padding:15px; background:var(--bg-38); border-radius:8px; margin-bottom:15px;">
                <div style="color:var(--success); font-weight:bold; margin-bottom:5px;">✅ 受け取り済み</div>
                <div style="font-size:12px; color:var(--txt-m);">次回: 明日のログイン時</div>
            </div>

            <div style="background:var(--bg-38); padding:15px; border-radius:8px; margin-top:15px; text-align:left;">
                <div style="font-size:12px; color:var(--txt-m); margin-bottom:10px;">💰 現在の所持コイン</div>
                <div style="font-size:28px; font-weight:bold;" id="bonus-current-coins">0</div>
            </div>

            <button onclick="$('#login-bonus-modal').addClass('hidden')" style="width:100%; background:var(--bg-38); color:var(--txt); border:none; margin-top:15px; cursor:pointer; padding:12px; border-radius:8px;">閉じる</button>
        </div>
    </div>

    <!-- ショップモーダル -->
    <div id="shop-modal" class="modal-overlay hidden">
        <div class="responsive-card" style="padding:20px; max-height:85vh; max-width:800px; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">🎁 ショップ</h3>
                <button onclick="$('#shop-modal').addClass('hidden')" style="background:none; border:none; color:var(--txt-m); font-size:24px; cursor:pointer; padding:5px;">✕</button>
            </div>
            
            <!-- コイン表示 -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:15px; border-radius:10px; text-align:center; margin-bottom:20px;">
                <div style="font-size:14px; color:rgba(255,255,255,0.8); margin-bottom:5px;">所持コイン</div>
                <div style="font-size:32px; font-weight:bold; color:white;">
                    💰 <span id="user-coins">0</span>
                </div>
                <div style="font-size:12px; color:rgba(255,255,255,0.7); margin-top:5px;">
                    ログインボーナス: 毎日 <span style="color:#ffd700; font-weight:bold;">+100</span> コイン
                </div>
            </div>

            <!-- アイテム一覧 -->
            <div style="flex:1; overflow-y:auto;">
                <h4 style="margin:10px 0; color:var(--txt-m); font-size:14px;">アイテム</h4>
                <div id="shop-items" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:12px; margin-bottom:15px;">
                    <!-- JavaScriptで動的に追加 -->
                </div>

                <!-- プレビューエリア（アイテム一覧の下） -->
                <div id="item-preview" class="hidden" style="background:var(--bg-38); padding:20px; border-radius:12px; margin-top:15px; border:2px solid #667eea; position:sticky; bottom:0;">
                    <div style="font-size:12px; color:var(--txt-m); margin-bottom:10px; text-transform:uppercase;">👁️ Preview</div>
                    <div style="display:flex; align-items:center; gap:20px;">
                        <!-- プレビュー用メッセージ -->
                        <div id="preview-message" class="message" style="margin:0; max-width:none;">
                            <div class="icon-container" id="preview-icon-container">
                                <img class="icon" id="preview-icon" src="" alt="">
                            </div>
                            <div class="bubble">
                                <div class="msg-head">
                                    <span class="sender" id="preview-name"></span>
                                    <span id="preview-badge"></span>
                                </div>
                                <div class="msg-body">プレビュー表示</div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <div id="preview-item-name" style="font-size:18px; font-weight:bold; margin-bottom:5px;"></div>
                            <div id="preview-item-desc" style="font-size:12px; color:var(--txt-m);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="$('#shop-modal').addClass('hidden')" style="width:100%; background:var(--bg-38); color:var(--txt); border:none; margin-top:15px; cursor:pointer; padding:12px; border-radius:5px;">閉じる</button>
        </div>
    </div>

    <!-- リアクションピッカー -->
    <div id="reaction-picker" class="hidden" style="position: fixed; z-index: 9999; background: var(--bg-2b); border-radius: 12px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
    </div>

    <style>
        .reaction-emoji {
            font-size: 28px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--bg-38);
            text-align: center;
            user-select: none;
        }
        .reaction-emoji:hover {
            transform: scale(1.2);
            background: var(--bg-31);
        }
        .reaction-emoji:active {
            transform: scale(0.95);
        }
        
        .shop-item {
            background: var(--bg-38);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .shop-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 5px 15px rgba(88, 101, 242, 0.3);
        }
        .shop-item.owned {
            background: linear-gradient(135deg, rgba(59, 165, 92, 0.2) 0%, rgba(59, 165, 92, 0.1) 100%);
            border-color: var(--success);
        }
        .shop-item-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }
        .shop-item-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--txt);
        }
        .shop-item-price {
            font-size: 16px;
            color: #ffd700;
            font-weight: bold;
        }
        .shop-item-owned {
            color: var(--success);
            font-size: 12px;
            font-weight: bold;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, doc, getDoc, getDocs, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, startAfter, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyA8X7HsOXDERBTy4GvLE8ibg3bk8JhldZg", authDomain: "chat-16746.firebaseapp.com", projectId: "chat-16746", storageBucket: "chat-16746.firebasestorage.app", messagingSenderId: "1009009975164", appId: "1:1009009975164:web:64192371271cb589614ef9" };
        const app = initializeApp(firebaseConfig);
        
        const db = initializeFirestore(app, {
            localCache: persistentLocalCache({tabManager: persistentMultipleTabManager()})
        });
        const auth = getAuth(app);

        // --- 通知音と設定用変数 ---
        const NOTIFY_SOUND_SRC = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFQAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhQAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhQAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAGlzb21tcDQyAFRTU0UAAAAOAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAALAAAAABAAKQAAAAAAAASDsAAAPAAAAEAAKgAAA0b+45BAAAAAEmQAAAAAAZAAAAAAAAAAAAAA//uQZAAACtWbMGPQwABO5GYdfhgAAy1hSg5l4AIk6ilBzLwAAAE1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQZAAAAAAAALAAAAABAAKQAAAAAAAASDsAAAPAAAAEAAKgAAA0b+45BAAAAAEmQAAAAAAZAAAAAAAAAAAAAA//uQZAAACtWbMGPQwABO5GYdfhgAAy1hSg5l4AIk6ilBzLwAAAE1FMy4xMDCqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";
        const notifyAudio = new Audio(NOTIFY_SOUND_SRC);
        notifyAudio.volume = 0.5;

        let unreadCount = 0;
        let unreadRooms = {}; // 各DM部屋の未読数を管理
        let lastSeenTimestamps = {}; // 各チャットの最終閲覧時刻
        let isSoundEnabled = localStorage.getItem("chat_sound_enabled") !== "false"; 

        function updateSoundBtnUI() {
            if(isSoundEnabled) {
                $("#toggleSoundBtn").removeClass("btn-toggle-off").addClass("btn-toggle-on");
                $("#toggleSoundBtn span:first").text("volume_up");
                $("#soundBtnText").text("通知音: ON");
            } else {
                $("#toggleSoundBtn").removeClass("btn-toggle-on").addClass("btn-toggle-off");
                $("#toggleSoundBtn span:first").text("volume_off");
                $("#soundBtnText").text("通知音: OFF");
            }
        }
        updateSoundBtnUI();

        $("#toggleSoundBtn").on("click", () => {
            isSoundEnabled = !isSoundEnabled;
            localStorage.setItem("chat_sound_enabled", isSoundEnabled);
            updateSoundBtnUI();
            if(isSoundEnabled) notifyAudio.play().catch(e=>console.log(e));
        });

        function clearUnread() {
            // 現在のチャットの最終閲覧時刻を記録
            const readKey = currentRoomId || "global";
            lastSeenTimestamps[readKey] = Date.now();
            localStorage.setItem('chat_last_seen_' + readKey, lastSeenTimestamps[readKey].toString());
            
            // このチャットの未読をクリア
            if(unreadRooms[readKey]) {
                delete unreadRooms[readKey];
                updateDMBadges();
            }
            
            // 全体の未読数を再計算
            recalculateTotalUnread();
            
            console.log("Cleared unread for:", readKey, "Total unread:", unreadCount);
        }
        
        // 全体の未読数を再計算してバッジを更新
        function recalculateTotalUnread() {
            const total = Object.values(unreadRooms).reduce((sum, count) => sum + count, 0);
            unreadCount = total;
            
            if(unreadCount > 0) {
                document.title = `(${unreadCount}) ゆきちゃっと`;
                $("#menuToggle").addClass("badge-notify");
            } else {
                document.title = "ゆきちゃっと";
                $("#menuToggle").removeClass("badge-notify");
            }
        }
        
        // DMバッジを更新する関数
        function updateDMBadges() {
            Object.keys(unreadRooms).forEach(roomId => {
                const count = unreadRooms[roomId] || 0;
                const $dmItem = $(`.sidebar-item[data-room-id="${roomId}"]`);
                
                if(count > 0) {
                    let $badge = $dmItem.find('.dm-unread-badge');
                    if($badge.length === 0) {
                        $dmItem.css('position', 'relative');
                        $dmItem.prepend('<div class="dm-unread-badge"></div>');
                        $badge = $dmItem.find('.dm-unread-badge');
                    }
                    $badge.text(count > 9 ? '9+' : count).show();
                } else {
                    $dmItem.find('.dm-unread-badge').remove();
                }
            });
        }
        // -----------------------

        const CLOUD_NAME = "DD17U0VMA", UPLOAD_PRESET = "my_chat_preset";
        const DEFAULT_AVATAR = "https://www.w3schools.com/howto/img_avatar.png";
        const DEFAULT_BANNER = "https://images.unsplash.com/photo-1614850523296-d8c1af93d400?auto=format&fit=crop&w=1000";

        function escapeHTML(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }

        const STAMP_LIST = [
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f600/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f60d/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f62d/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f602/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f44d/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f525/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f389/512.webp",
            "https://fonts.gstatic.com/s/e/notoemoji/latest/1f4af/512.webp"
        ];

        let pendingImageUrl = null, replyTarget = null, editTargetId = null, pc, localStream, currentCallId = null;
        let currentRoomId = null;
        let currentUnsubscribe = null;
        let globalUnsubscribers = [];
        let friendIds = [];
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };
        let currentTab = 'all', usersCache = {}, isInitialLoad = true, lastMsgCount = 0;
        let typingTimeout;

        let lastVisibleDoc = null; 
        let isFetchingMore = false;
        let hasMoreMessages = true;
        const PAGE_SIZE = 30;

        async function baseUpload(file, isProfile = false, profileText = "画像をアップロード中") {
            if(!file || !file.type.startsWith('image/')) return null;
            
            if(isProfile) {
                $("#profile-upload-text").text(profileText);
                $("#profile-upload-status").removeClass("hidden");
            } else {
                $("#upload-status-indicator").removeClass("hidden");
            }
            
            $("#sendBtn, #saveProfile").prop("disabled", true).css("opacity", "0.5");
            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: fd });
                const data = await res.json(); 
                return data.secure_url;
            } catch (err) { 
                alert("アップロード失敗"); 
                return null;
            } finally {
                if(isProfile) {
                    $("#profile-upload-status").addClass("hidden");
                } else {
                    $("#upload-status-indicator").addClass("hidden");
                }
                $("#sendBtn, #saveProfile").prop("disabled", false).css("opacity", "1");
            }
        }

        async function uploadImageFile(file) {
            const url = await baseUpload(file);
            if(url) {
                pendingImageUrl = url;
                $("#img-preview-src").attr("src", pendingImageUrl); 
                $("#upload-preview-container").removeClass("hidden");
            }
            $("#real_file_input").val("");
        }

        async function uploadAvatarFile(file) {
            const url = await baseUpload(file, true, "アイコンをアップロード中");
            if(url) {
                $("#editPhoto").val(url);
                syncProfilePreview();
            }
            $("#real_avatar_input").val("");
        }

        async function uploadBannerFile(file) {
            const url = await baseUpload(file, true, "バナーをアップロード中");
            if(url) {
                $("#editBanner").val(url);
                syncProfilePreview();
            }
            $("#real_banner_input").val("");
        }

        const $chatInputArea = $("#chat-input-area");
        $(document).on("dragover", (e) => { e.preventDefault(); $chatInputArea.addClass("drag-over"); });
        $(document).on("dragleave drop", (e) => { e.preventDefault(); $chatInputArea.removeClass("drag-over"); });
        $(document).on("drop", (e) => {
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) uploadImageFile(files[0]);
        });

        $("#messageInput").on("paste", (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    uploadImageFile(blob);
                }
            }
        });

        window.toggleSidebar = (show) => {
            if(show) {
                $("#sidebar").addClass("open");
                $("#sidebar-overlay").fadeIn(200);
                updateSidebarDMList();
            } else {
                $("#sidebar").removeClass("open");
                $("#sidebar-overlay").fadeOut(200);
            }
        };
        $("#menuToggle, #sidebar-overlay").on("click", () => toggleSidebar(!$("#sidebar").hasClass("open")));

        async function updateSidebarDMList() {
            const $dmList = $("#dm-list").empty();
            if(friendIds.length === 0) {
                $dmList.append('<div style="padding:10px; font-size:12px; color:var(--txt-m);">フレンドがいません</div>');
                return;
            }
            friendIds.forEach(fid => {
                const u = usersCache[fid];
                if(!u) return;
                const roomId = [auth.currentUser.uid, fid].sort().join("_");
                const activeClass = currentRoomId === roomId ? 'active' : '';
                const statusClass = u.status === 'online' ? 'online' : 'offline';
                const unreadCount = unreadRooms[roomId] || 0;
                const badgeHtml = unreadCount > 0 ? `<div class="dm-unread-badge">${unreadCount > 9 ? '9+' : unreadCount}</div>` : '';
                
                $dmList.append(`
                    <div class="sidebar-item ${activeClass}" onclick="openDM('${fid}','${escapeHTML(u.name)}')" data-user-id="${fid}" data-room-id="${roomId}" style="position: relative;">
                        ${badgeHtml}
                        <div class="icon-container">
                            <img src="${u.photo || DEFAULT_AVATAR}" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">
                            <div class="status-dot ${statusClass}"></div>
                        </div>
                        <span style="font-size:14px;">${escapeHTML(u.name)}</span>
                    </div>
                `);
            });
        }

        function scrollToBottom(force = false) {
            // 過去メッセージ読み込み中はスクロールしない
            if (isLoadingMoreMessages) return;
            
            const $box = $("#messages");
            if ($box.length === 0) return;
            
            const threshold = 150;
            const isAtBottom = ($box[0].scrollHeight - $box.scrollTop() <= $box[0].clientHeight + threshold);
            
            if (force || isAtBottom) {
                // アニメーションなしで即座に一番下へ移動（確実に届く）
                $box[0].scrollTop = $box[0].scrollHeight;
                
                // さらに念押しで確実に一番下へ
                requestAnimationFrame(() => {
                    $box[0].scrollTop = $box[0].scrollHeight;
                });
            }
        }
        window.scrollToBottom = scrollToBottom;

        onAuthStateChanged(auth, async (user) => {
            $("#init-loader").fadeOut();
            $("#app-wrapper").addClass("visible");
            
            if (user) {
                // ページロード時に既読状態を復元
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if(key.startsWith('chat_last_seen_')) {
                        const roomKey = key.replace('chat_last_seen_', '');
                        const timestamp = parseInt(localStorage.getItem(key));
                        if(!isNaN(timestamp)) {
                            lastSeenTimestamps[roomKey] = timestamp;
                        }
                    }
                });
                console.log("Restored last seen timestamps:", lastSeenTimestamps);
                
                if (user.isAnonymous) {
                    const exp = new Date(); 
                    exp.setDate(exp.getDate() + 30);
                    
                    const uRef = doc(db, "users", user.uid);
                    const s = await getDoc(uRef);
                    if(!s.exists()) {
                        await setDoc(uRef, { name: "ゲスト", photo: DEFAULT_AVATAR, status: "online", isTyping: false, expireAt: exp, isAnonymous: true });
                    } else {
                        await updateDoc(uRef, { expireAt: exp, isAnonymous: true });
                    }
                }

                setOnline();
                $("#auth-container").addClass("hidden");
                $("#app-wrapper").addClass("visible");
                $("#myName").text(user.displayName || "ゲスト");
                $("#myIconContainer").html(`<div class="icon-container"><img src="${user.photoURL || DEFAULT_AVATAR}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;"><div class="status-dot online"></div></div>`);
                
                // ユーザー名が「ゲスト」の場合、警告バナーを表示
                if (user.displayName === "ゲスト" || !user.displayName) {
                    $("#guest-warning-banner").show();
                }
                
                // ログインボーナスチェック（匿名ユーザーは除く）
                if (!user.isAnonymous) {
                    const canClaim = await checkLoginBonus();
                    if (canClaim) {
                        // まだ受け取ってない場合、3秒後に自動表示
                        setTimeout(() => {
                            openLoginBonusModal();
                        }, 3000);
                    }
                }
                
                // テーマを適用
                applyUserTheme();
                
                // 通知ボタンのUIを初期化
                updateNotificationButtonUI();
                
                const unsubFriends = onSnapshot(collection(db, "friendRequests"), (snap) => {
                    friendIds = [];
                    
                    // 変更を検知してフレンド申請通知を表示
                    snap.docChanges().forEach(change => {
                        const data = change.doc.data();
                        const reqId = change.doc.id;
                        
                        // 新しいフレンド申請が来た場合
                        if (change.type === "added" && data.to === user.uid && data.status === "pending") {
                            // 送信者の情報を取得
                            const senderData = usersCache[data.from];
                            const senderName = senderData ? senderData.name : "ゲスト";
                            const senderPhoto = senderData ? senderData.photo : DEFAULT_AVATAR;
                            
                            // バッジとタイトル更新
                            triggerBadge("friend_request_" + reqId);
                            
                            // 音を鳴らす
                            if (isSoundEnabled) {
                                notifyAudio.currentTime = 0;
                                notifyAudio.play().catch(e => console.log("Audio play blocked", e));
                            }
                            
                            // ブラウザ通知
                            if (notificationsEnabled) {
                                const n = new Notification("新しいフレンド申請", {
                                    body: `${senderName}さんからフレンド申請が届きました`,
                                    icon: senderPhoto,
                                    tag: 'friend-request-' + reqId
                                });
                                n.onclick = () => { 
                                    window.focus(); 
                                    $("#openUserListBtn").click();
                                };
                            }
                            
                            console.log("New friend request from:", senderName);
                        }
                        
                        // フレンド申請が承認された場合
                        if (change.type === "modified" && data.from === user.uid && data.status === "accepted") {
                            const accepterData = usersCache[data.to];
                            const accepterName = accepterData ? accepterData.name : "ゲスト";
                            const accepterPhoto = accepterData ? accepterData.photo : DEFAULT_AVATAR;
                            
                            // 承認通知
                            if (notificationsEnabled) {
                                const n = new Notification("フレンド申請が承認されました", {
                                    body: `${accepterName}さんがフレンド申請を承認しました`,
                                    icon: accepterPhoto,
                                    tag: 'friend-accepted-' + reqId
                                });
                                n.onclick = () => { 
                                    window.focus(); 
                                    openDM(data.to, accepterName);
                                };
                            }
                            
                            console.log("Friend request accepted by:", accepterName);
                        }
                    });
                    
                    // フレンドリストを更新
                    snap.forEach(d => {
                        const data = d.data();
                        if (data.status === "accepted") {
                            if (data.from === user.uid) friendIds.push(data.to);
                            if (data.to === user.uid) friendIds.push(data.from);
                        }
                    });
                    if ($("#sidebar").hasClass("open")) updateSidebarDMList();
                });

                // ユーザー状態の更新をデバウンス（パフォーマンス向上）
                const updateUserStatuses = debounce(() => {
                    Object.keys(usersCache).forEach(uid => {
                        const userData = usersCache[uid];
                        const statusClass = userData.status === 'online' ? 'online' : 'offline';
                        
                        // DOM更新を最小限に
                        const $messageDots = $(`.message[data-uid="${uid}"] .status-dot`);
                        const $sidebarDots = $(`.sidebar-item[data-user-id="${uid}"] .status-dot`);
                        
                        if ($messageDots.length) {
                            $messageDots.removeClass('online offline').addClass(statusClass);
                        }
                        if ($sidebarDots.length) {
                            $sidebarDots.removeClass('online offline').addClass(statusClass);
                        }
                        
                        // ユーザーリストモーダルが開いている時だけ更新
                        if (!$("#user-list-modal").hasClass("hidden")) {
                            const $userDots = $(`.user-item[data-uid="${uid}"] .status-dot`);
                            if ($userDots.length) {
                                $userDots.removeClass('online offline').addClass(statusClass);
                            }
                        }
                    });
                }, 100); // 100ms デバウンス
                
                const unsubUsers = onSnapshot(collection(db, "users"), (snap) => {
                    let typingNames = [];
                    
                    // 変更があったユーザーだけ処理（パフォーマンス向上）
                    snap.docChanges().forEach(change => {
                        const userDoc = change.doc;
                        const userData = userDoc.data();
                        const uid = userDoc.id;
                        
                        usersCache[uid] = userData;
                        
                        if(uid !== auth.currentUser.uid && userData.isTyping) {
                            typingNames.push(userData.name || "ゲスト");
                        }
                    });
                    
                    // タイピングインジケーターの更新
                    if(typingNames.length > 0) {
                        $("#typing-indicator").text(typingNames.map(n => escapeHTML(n)).join(", ") + " が入力中...").removeClass("hidden");
                    } else {
                        $("#typing-indicator").addClass("hidden");
                    }
                    
                    // 状態ドットの更新（デバウンス）
                    updateUserStatuses();
                });

                // --- 新着DM（バックグラウンド）検知用のリスナー ---
                // 自分が参加している部屋の更新を監視
                const unsubRooms = onSnapshot(query(collection(db, "rooms"), where("users", "array-contains", user.uid)), (snap) => {
                    snap.docChanges().forEach(change => {
                        if(change.type === "modified" || change.type === "added") {
                            const d = change.doc.data();
                            const roomId = change.doc.id;
                            
                            // 自分以外の更新で、かつ現在開いている部屋ではない場合
                            if (d.updatedBy && d.updatedBy !== user.uid && roomId !== currentRoomId) {
                                // 最終閲覧時刻より新しい更新かチェック
                                const lastSeen = lastSeenTimestamps[roomId] || 0;
                                const updatedTime = d.updatedAt ? d.updatedAt.toMillis() : Date.now();
                                
                                if(updatedTime > lastSeen) {
                                    triggerBadge(roomId);
                                }
                            }
                        }
                    });
                    
                    // サイドバーのDMリストを更新
                    if ($("#sidebar").hasClass("open")) {
                        updateSidebarDMList();
                    }
                });

                globalUnsubscribers.push(unsubFriends, unsubUsers, unsubRooms);
                switchChat(null);
                listenForCalls();
                initStampPicker();
            } else {
                $("#app-wrapper").removeClass("visible");
                $("#auth-container").removeClass("hidden");
                globalUnsubscribers.forEach(unsub => unsub());
                globalUnsubscribers = [];
            }
        });

        const syncProfilePreview = () => {
            $("#editPreviewName").text($("#editName").val() || "ゲスト");
            $("#editPreviewAvatar").attr("src", $("#editPhoto").val() || DEFAULT_AVATAR);
            $("#editPreviewBanner").attr("src", $("#editBanner").val() || DEFAULT_BANNER);
            $("#editPreviewBio").text($("#editBio").val() || "自己紹介はまだありません。");
            
            // エフェクトプレビュー
            const selectedEffect = $("#editEquippedEffect").val();
            $("#editPreviewAvatarContainer").removeClass('effect-fire effect-sparkle effect-lightning effect-rainbow effect-shadow effect-ice effect-toxic effect-gold');
            
            if (selectedEffect === 'fire_effect') $("#editPreviewAvatarContainer").addClass('effect-fire');
            else if (selectedEffect === 'sparkle_effect') $("#editPreviewAvatarContainer").addClass('effect-sparkle');
            else if (selectedEffect === 'lightning_effect') $("#editPreviewAvatarContainer").addClass('effect-lightning');
            else if (selectedEffect === 'rainbow_effect') $("#editPreviewAvatarContainer").addClass('effect-rainbow');
            else if (selectedEffect === 'shadow_effect') $("#editPreviewAvatarContainer").addClass('effect-shadow');
            else if (selectedEffect === 'ice_effect') $("#editPreviewAvatarContainer").addClass('effect-ice');
            else if (selectedEffect === 'toxic_effect') $("#editPreviewAvatarContainer").addClass('effect-toxic');
            else if (selectedEffect === 'gold_effect') $("#editPreviewAvatarContainer").addClass('effect-gold');
            
            // バッジプレビュー
            const selectedBadge = $("#editEquippedBadge").val();
            const $badgePreview = $("#editPreviewBadge").empty();
            
            if (selectedBadge === 'vip_badge') {
                $badgePreview.html('<span class="user-badge" title="VIP">👑</span>');
            } else if (selectedBadge === 'star_badge') {
                $badgePreview.html('<span class="user-badge" title="スター">⭐</span>');
            } else if (selectedBadge === 'crown_badge') {
                $badgePreview.html('<span class="user-badge" title="プレミアム">👸</span>');
            }
        };
        $("#editName, #editPhoto, #editBanner, #editBio, #editEquippedEffect, #editEquippedBadge").on("input change", syncProfilePreview);

        window.switchChat = (roomId, otherName = null) => {
            currentRoomId = roomId;
            isInitialLoad = true;
            lastMsgCount = 0;
            lastVisibleDoc = null;
            hasMoreMessages = true;
            $("#messages").empty();
            if (currentUnsubscribe) currentUnsubscribe();
            $(".sidebar-item").removeClass("active");
            if(!roomId) $(".sidebar-item:first").addClass("active");

            const colRef = roomId ? collection(db, "rooms", roomId, "messages") : collection(db, "chats");
            if (roomId) $("#headerTitle").text(otherName + " とのDM");
            else $("#headerTitle").text("グローバルチャット");

            const msgQuery = query(colRef, orderBy("createdAt", "desc"), limit(PAGE_SIZE));
            currentUnsubscribe = onSnapshot(msgQuery, (snap) => {
                if (isInitialLoad && !snap.empty) {
                    lastVisibleDoc = snap.docs[snap.docs.length - 1];
                }
                renderMessages(snap, true);
                // チャット切り替え後、少し待ってから既読マーク
                if(isInitialLoad) {
                    setTimeout(() => {
                        if(document.hasFocus() && document.visibilityState === 'visible') {
                            clearUnread();
                        }
                    }, 500);
                }
            });
        };

        let isLoadingMoreMessages = false; // 過去メッセージ読み込み中フラグ
        let pauseSnapshot = false; // onSnapshotを一時停止するフラグ
        
        // デバウンス関数（連続実行を防ぐ）
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        async function loadMoreMessages() {
            if (isFetchingMore || !hasMoreMessages || !lastVisibleDoc) return;
            isFetchingMore = true;
            isLoadingMoreMessages = true; // フラグを立てる
            pauseSnapshot = true; // onSnapshotの処理を止める
            
            const $box = $("#messages");
            
            // 現在見ている最初のメッセージ要素を基準として保存
            const firstVisibleMessage = $box.children().first()[0];
            const firstMessageId = firstVisibleMessage ? firstVisibleMessage.id : null;
            
            console.log("Before load - first message:", firstMessageId, "scrollTop:", $box.scrollTop());
            
            $("#messages").prepend('<div id="load-more-indicator">過去のメッセージを読み込み中...</div>');
            const colRef = currentRoomId ? collection(db, "rooms", currentRoomId, "messages") : collection(db, "chats");
            const nextQuery = query(colRef, orderBy("createdAt", "desc"), startAfter(lastVisibleDoc), limit(PAGE_SIZE));
            try {
                const snap = await getDocs(nextQuery);
                $("#load-more-indicator").remove();
                if (snap.empty) { 
                    hasMoreMessages = false; 
                    isFetchingMore = false; 
                    isLoadingMoreMessages = false; 
                    pauseSnapshot = false;
                    return; 
                }
                lastVisibleDoc = snap.docs[snap.docs.length - 1];
                if (snap.size < PAGE_SIZE) hasMoreMessages = false;
                let html = "";
                let docs = [];
                snap.forEach(d => docs.push({id: d.id, data: d.data()}));
                // 逆順にする（古い順に表示するため）
                docs.reverse();
                docs.forEach(item => { html += generateMessageHtml(item.id, item.data); });
                $("#messages").prepend(html);
                
                // 基準メッセージの位置までスクロール（見た目が変わらないように）
                if (firstMessageId) {
                    const firstMessageElement = document.getElementById(firstMessageId);
                    if (firstMessageElement) {
                        // 基準メッセージを画面の同じ位置に保つ
                        firstMessageElement.scrollIntoView({ block: 'start', behavior: 'instant' });
                        console.log("Scrolled to preserve message:", firstMessageId);
                    }
                }
                
                console.log("Loaded more messages, final scrollTop:", $box.scrollTop());
                
            } catch (err) { console.error("Load more error:", err); } 
            finally { 
                isFetchingMore = false;
                // 少し待ってからフラグを下ろす
                setTimeout(() => {
                    isLoadingMoreMessages = false;
                    pauseSnapshot = false;
                    console.log("Resumed normal mode");
                }, 1500);
            }
        }

        function generateMessageHtml(id, d) {
            const isMe = d.uid === auth.currentUser.uid;
            const isFriend = friendIds.includes(d.uid);
            const reactions = d.reactions || {};
            const userStatus = usersCache[d.uid]?.status || "offline";
            const isStamp = !!d.stamp;
            
            // ユーザーの装備アイテムを取得
            const userData = usersCache[d.uid] || {};
            const equipped = userData.equipped || {};
            
            // 装備されたバッジのみを表示
            let badgeHtml = '';
            const badgeMap = {
                'vip_badge': { icon: '👑', title: 'VIP' },
                'star_badge': { icon: '⭐', title: 'スター' },
                'crown_badge': { icon: '👸', title: 'プレミアム' }
            };
            if (equipped.badge && badgeMap[equipped.badge]) {
                const badge = badgeMap[equipped.badge];
                badgeHtml = `<span class="user-badge" title="${badge.title}">${badge.icon}</span>`;
            }
            
            // 装備されたエフェクトのみを適用（メッセージ全体に）
            let effectClass = '';
            if (equipped.effect === 'fire_effect') effectClass = 'effect-fire';
            else if (equipped.effect === 'sparkle_effect') effectClass = 'effect-sparkle';
            else if (equipped.effect === 'lightning_effect') effectClass = 'effect-lightning';
            else if (equipped.effect === 'rainbow_effect') effectClass = 'effect-rainbow';
            else if (equipped.effect === 'shadow_effect') effectClass = 'effect-shadow';
            else if (equipped.effect === 'ice_effect') effectClass = 'effect-ice';
            else if (equipped.effect === 'toxic_effect') effectClass = 'effect-toxic';
            else if (equipped.effect === 'gold_effect') effectClass = 'effect-gold';
            
            let rHtml = '';
            for (const [emoji, uids] of Object.entries(reactions)) {
                if (uids.length > 0) rHtml += `<div class="reaction-badge ${uids.includes(auth.currentUser.uid)?'active':''}" onclick="react('${id}','${emoji}',${JSON.stringify(reactions).replace(/"/g, '&quot;')})">${emoji} ${uids.length}</div>`;
            }
            const imgHtml = d.image ? `<img src="${d.image}" class="sent-img" onclick="window.open('${d.image}')">` : '';
            const stampHtml = d.stamp ? `<img src="${d.stamp}" class="stamp-display">` : '';
            const safeName = escapeHTML(d.name || "ゲスト");
            const safeText = escapeHTML(d.text || "");
            const replyName = d.replyTo ? escapeHTML(d.replyTo.name) : "";
            const replyText = d.replyTo ? escapeHTML(d.replyTo.text) : "";

            return `<div class="message ${isMe?'me':''} ${isStamp?'is-stamp':''} ${isFriend?'is-friend':''} ${effectClass}" id="msg-${id}" data-uid="${d.uid}">
                <div class="icon-container" onclick="showProfile('${d.uid}')">
                    <img src="${d.photo || DEFAULT_AVATAR}" class="icon">
                    <div class="status-dot ${userStatus === 'online' ? 'online' : 'offline'}"></div>
                </div>
                <div class="msg-body">
                    <div class="user-info">${safeName}${badgeHtml}</div>
                    <div class="bubble">
                        ${d.replyTo ? `<div class="reply-in-bubble" onclick="scrollToMsg('${d.replyTo.id}')">@${replyName} ${replyText}</div>` : ''}
                        ${d.text ? `<div>${safeText}${d.isEdited ? '<span class="edited-mark">(編集済)</span>' : ''}</div>` : ''}
                        ${imgHtml}
                        ${stampHtml}
                    </div>
                    <div class="msg-ops">
                        ${rHtml}
                        <span class="material-symbols-outlined op-btn" onclick="openReactionPicker('${id}', event, ${JSON.stringify(reactions).replace(/"/g, '&quot;')})" title="リアクション">add_reaction</span>
                        <span class="material-symbols-outlined op-btn" onclick="setReply('${id}','${safeName.replace(/'/g, "\\'")}','${(safeText || (isStamp?"スタンプ":"画像")).replace(/'/g, "\\'").replace(/\n/g, " ")}')" title="返信">reply</span>
                        ${isMe && !isStamp ? `<span class="material-symbols-outlined op-btn" onclick="setEdit('${id}','${safeText.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" title="編集">edit</span>` : ''}
                        ${isMe ? `<span class="material-symbols-outlined op-btn" style="color:var(--danger);" onclick="deleteMsg('${id}')" title="削除">delete</span>` : ''}
                    </div>
                </div></div>`;
        }

        $("#messages").on("scroll", function() { if ($(this).scrollTop() === 0) loadMoreMessages(); });

        let notificationsEnabled = localStorage.getItem("chat_notifications_enabled") === "true";

        // ページ読み込み時に通知権限をチェックして状態を復元
        if ('Notification' in window && Notification.permission === 'granted') {
            notificationsEnabled = localStorage.getItem("chat_notifications_enabled") !== "false";
        } else {
            notificationsEnabled = false;
        }

        function triggerBadge(roomId = null) {
            // DM別の未読カウント
            if(roomId) {
                unreadRooms[roomId] = (unreadRooms[roomId] || 0) + 1;
                updateDMBadges();
            }
            
            // 全体の未読数を再計算
            recalculateTotalUnread();
            
            if (isSoundEnabled) {
                notifyAudio.currentTime = 0;
                notifyAudio.play().catch(e => console.log("Audio play blocked", e));
            }
        }

        function renderMessages(snap, isDesc = false) {
            // onSnapshotが一時停止中なら何もしない
            if (pauseSnapshot) {
                console.log("renderMessages blocked - pauseSnapshot is true");
                return;
            }
            
            const $box = $("#messages");
            const currentMsgCount = snap.size;
            
            // 過去メッセージ読み込み中は新着メッセージ判定をスキップ
            const hasNewMessage = !isLoadingMoreMessages && (currentMsgCount > lastMsgCount);
            
            let docs = [];
            snap.forEach(d => docs.push({id: d.id, data: d.data()}));
            if(isDesc) docs.reverse();
            
            if (isInitialLoad) {
                // DocumentFragmentを使ってバッチ挿入（パフォーマンス向上）
                const fragment = document.createDocumentFragment();
                const tempDiv = document.createElement('div');
                
                docs.forEach((item) => {
                    tempDiv.innerHTML = generateMessageHtml(item.id, item.data);
                    while (tempDiv.firstChild) {
                        fragment.appendChild(tempDiv.firstChild);
                    }
                });
                
                $box.empty();
                $box[0].appendChild(fragment);
                
                // 過去メッセージ読み込み中でなければスクロール
                if (!isLoadingMoreMessages) {
                    // 即座に一番下へ
                    $box[0].scrollTop = $box[0].scrollHeight;
                    
                    // 画像読み込み待ちで何度も試行（確実に一番下へ）
                    requestAnimationFrame(() => {
                        $box[0].scrollTop = $box[0].scrollHeight;
                    });
                    setTimeout(() => {
                        $box[0].scrollTop = $box[0].scrollHeight;
                    }, 50);
                    setTimeout(() => {
                        $box[0].scrollTop = $box[0].scrollHeight;
                    }, 100);
                    setTimeout(() => {
                        $box[0].scrollTop = $box[0].scrollHeight;
                    }, 200);
                }
                isInitialLoad = false;
            } else {
                // 更新が必要なメッセージだけ処理（パフォーマンス向上）
                const updates = [];
                const additions = [];
                
                docs.forEach((item) => {
                    const existing = $(`#msg-${item.id}`);
                    if (existing.length) {
                        updates.push({element: existing, html: generateMessageHtml(item.id, item.data)});
                    } else {
                        additions.push(generateMessageHtml(item.id, item.data));
                    }
                });
                
                // バッチ更新
                updates.forEach(({element, html}) => element.replaceWith(html));
                
                // バッチ追加（DocumentFragment使用）
                if (additions.length > 0) {
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    
                    additions.forEach(html => {
                        tempDiv.innerHTML = html;
                        while (tempDiv.firstChild) {
                            fragment.appendChild(tempDiv.firstChild);
                        }
                    });
                    
                    $box[0].appendChild(fragment);
                }
                
                if (hasNewMessage) {
                    // 過去メッセージ読み込み中でなければスクロール
                    if (!isLoadingMoreMessages) {
                        scrollToBottom(true);
                    }
                    
                    const lastDoc = docs[docs.length - 1];
                    // --- 通知・バッジ処理（強化版） ---
                    if (auth.currentUser && lastDoc.data.uid !== auth.currentUser.uid) {
                        
                        // バッジを表示すべきか判定
                        // 1. ページが非表示 または フォーカスがない
                        // 2. または、一番下までスクロールしていない（過去ログを見ていて新着に気づいていない）
                        const isAtBottom = ($box[0].scrollHeight - $box.scrollTop() <= $box[0].clientHeight + 150);
                        const isUnseen = document.visibilityState === 'hidden' || !document.hasFocus() || !isAtBottom;

                        if (isUnseen) {
                            const roomIdForBadge = currentRoomId || "global";
                            
                            // 最終閲覧時刻より新しいメッセージかチェック
                            const lastSeen = lastSeenTimestamps[roomIdForBadge] || 0;
                            const msgTime = lastDoc.data.createdAt ? lastDoc.data.createdAt.toMillis() : Date.now();
                            
                            // 既読済みのメッセージはスキップ
                            if(msgTime > lastSeen) {
                                triggerBadge(roomIdForBadge);
                                
                                // ブラウザ通知（許可されている場合のみ）
                                if (notificationsEnabled && (document.visibilityState === 'hidden' || !document.hasFocus())) {
                                    const notificationTitle = `新着: ${lastDoc.data.name || "ゲスト"}`;
                                    const notificationBody = lastDoc.data.text || (lastDoc.data.stamp ? "スタンプ" : "画像");
                                    const n = new Notification(notificationTitle, {
                                        body: notificationBody,
                                        icon: lastDoc.data.photo || DEFAULT_AVATAR,
                                        tag: 'chat-msg'
                                    });
                                    n.onclick = () => { window.focus(); };
                                }
                            }
                        } else {
                            // 見ている状態なら即座に既読マーク
                            clearUnread();
                        }
                    }
                    // -------------------
                }
            }
            // 過去メッセージ読み込み中でなければlastMsgCountを更新
            // これにより、過去メッセージ読み込み中にonSnapshotが発火しても新着扱いされない
            if (!isLoadingMoreMessages) {
                lastMsgCount = currentMsgCount;
            }
        }

        let isSending = false; // 送信中フラグ
        
        const send = async () => {
            // 送信中なら何もしない（連打防止）
            if (isSending) return;
            
            const txt = $("#messageInput").val().trim(); 
            if (!txt && !pendingImageUrl) return;
            
            // 送信中フラグを立てる
            isSending = true;
            $("#sendBtn").css("opacity", "0.5").css("pointer-events", "none"); // ボタンを無効化
            
            try {
                const colRef = currentRoomId ? collection(db, "rooms", currentRoomId, "messages") : collection(db, "chats");
                if(editTargetId) {
                    await updateDoc(doc(colRef, editTargetId), { text: txt, isEdited: true });
                    cancelEdit();
                } else {
                    await addDoc(colRef, { text: txt, image: pendingImageUrl, uid: auth.currentUser.uid, name: auth.currentUser.displayName || "ゲスト", photo: auth.currentUser.photoURL || DEFAULT_AVATAR, createdAt: serverTimestamp(), replyTo: replyTarget, reactions: {} });
                    
                    // DMの場合、親ルーム情報の更新日時を更新（他のユーザーに通知を飛ばすため）
                    if (currentRoomId) {
                        await updateDoc(doc(db, "rooms", currentRoomId), { lastMessage: txt || "画像", updatedAt: serverTimestamp(), updatedBy: auth.currentUser.uid });
                    }

                    scrollToBottom(true);
                }
                $("#messageInput").val("").css("height", "auto"); 
                pendingImageUrl = null; 
                replyTarget = null; 
                $("#upload-preview-container, #reply-preview").addClass("hidden");
                updateTypingStatus(false);
            } catch (error) {
                console.error("Send error:", error);
                alert("メッセージの送信に失敗しました");
            } finally {
                // 送信完了後、フラグを下ろしてボタンを有効化
                setTimeout(() => {
                    isSending = false;
                    $("#sendBtn").css("opacity", "1").css("pointer-events", "auto");
                }, 500); // 0.5秒のクールダウン
            }
        };

        const updateTypingStatus = async (isTyping) => {
            if(!auth.currentUser) return;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { isTyping: isTyping });
        };

        $("#messageInput").on("input", function() {
            updateTypingStatus(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => updateTypingStatus(false), 3000);
        });

        window.sendStamp = async (url) => {
            const colRef = currentRoomId ? collection(db, "rooms", currentRoomId, "messages") : collection(db, "chats");
            await addDoc(colRef, { stamp: url, uid: auth.currentUser.uid, name: auth.currentUser.displayName || "ゲスト", photo: auth.currentUser.photoURL || DEFAULT_AVATAR, createdAt: serverTimestamp(), replyTo: replyTarget, reactions: {} });
            
             // DMの場合、親ルーム情報の更新日時を更新
            if (currentRoomId) {
                await updateDoc(doc(db, "rooms", currentRoomId), { lastMessage: "スタンプ", updatedAt: serverTimestamp(), updatedBy: auth.currentUser.uid });
            }

            replyTarget = null; $("#reply-preview").addClass("hidden"); $("#stamp-modal").addClass("hidden");
            scrollToBottom(true);
        };

        const initStampPicker = () => {
            const $list = $("#stamp-list").empty();
            STAMP_LIST.forEach(url => { $list.append(`<img src="${url}" class="stamp-item" onclick="sendStamp('${url}')">`); });
        };

        // ========== アイテム効果適用 ==========
        
        // ユーザーのテーマを適用
        async function applyUserTheme() {
            try {
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                const userData = userDoc.data();
                const equipped = userData.equipped || {};
                
                // 既存のテーマクラスを削除
                $('body').removeClass('rainbow-theme heart-theme');
                
                // 装備しているテーマを適用
                if (equipped.theme === 'rainbow_theme') {
                    $('body').addClass('rainbow-theme');
                    console.log('🌈 Rainbow theme applied');
                } else if (equipped.theme === 'heart_theme') {
                    $('body').addClass('heart-theme');
                    console.log('💕 Heart theme applied');
                }
            } catch (error) {
                console.error('Theme application error:', error);
            }
        }

        // ========== ショップシステム ==========
        
        // 🔐 管理者メールアドレスリスト（全アイテム自動解放 + 無限コイン）
        // ⚠️ 本番環境では必ず実際のメールアドレスに変更してください
        const ADMIN_EMAILS = [
            // 'your-email@example.com',  // ← ここに管理者のメールアドレスを追加
            // 'admin@example.com'
        ];
        
        const shopItems = [
            { id: 'vip_badge', name: 'VIPバッジ', icon: '👑', price: 300, description: '名前の横にVIPバッジが表示されます' },
            { id: 'rainbow_theme', name: 'レインボーテーマ', icon: '🌈', price: 250, description: 'チャット背景が虹色に' },
            { id: 'fire_effect', name: '炎エフェクト', icon: '🔥', price: 200, description: 'メッセージに炎エフェクト' },
            { id: 'star_badge', name: 'スターバッジ', icon: '⭐', price: 150, description: '名前の横にスターが表示' },
            { id: 'heart_theme', name: 'ハートテーマ', icon: '💕', price: 180, description: 'ピンク色のテーマ' },
            { id: 'sparkle_effect', name: 'キラキラエフェクト', icon: '✨', price: 220, description: 'メッセージがキラキラ' },
            { id: 'crown_badge', name: 'クラウンバッジ', icon: '👸', price: 350, description: 'プレミアムクラウン' },
            { id: 'lightning_effect', name: '稲妻エフェクト', icon: '⚡', price: 280, description: 'メッセージに稲妻' },
            { id: 'rainbow_effect', name: '虹色エフェクト', icon: '🌟', price: 300, description: '虹色に輝くオーラ' },
            { id: 'shadow_effect', name: 'シャドウエフェクト', icon: '🌑', price: 250, description: '暗黒のオーラ' },
            { id: 'ice_effect', name: '氷エフェクト', icon: '❄️', price: 260, description: '氷の結晶エフェクト' },
            { id: 'toxic_effect', name: '毒エフェクト', icon: '☠️', price: 270, description: '紫色の毒々しいオーラ' },
            { id: 'gold_effect', name: 'ゴールドエフェクト', icon: '💛', price: 400, description: '金色に輝く豪華なオーラ' }
        ];

        // 管理者かどうかチェック
        function isAdmin(email) {
            return ADMIN_EMAILS.includes(email);
        }

        // 管理者権限の自動付与
        async function unlockAllItemsForAdmin() {
            if (!auth.currentUser || !auth.currentUser.email) return;
            
            if (isAdmin(auth.currentUser.email)) {
                try {
                    const allItemIds = shopItems.map(item => item.id);
                    
                    await setDoc(doc(db, "users", auth.currentUser.uid), {
                        ownedItems: allItemIds,
                        isAdmin: true,
                        coins: 999999  // 管理者には無限コイン
                    }, { merge: true });
                    
                    console.log('🔓 Admin detected: All items unlocked');
                } catch (error) {
                    console.error('Admin unlock error:', error);
                }
            }
        }

        // ログインボーナスのチェック
        async function checkLoginBonus() {
            try {
                // 管理者チェック
                await unlockAllItemsForAdmin();
                
                // Firestoreから最終ログイン日を取得
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                if (!userDoc.exists()) {
                    return true; // 初回ログイン
                }
                
                const userData = userDoc.data();
                const lastLogin = userData.lastLogin;
                
                if (!lastLogin) {
                    return true; // lastLoginがない場合は受け取り可能
                }
                
                // Firestoreのタイムスタンプから日付を取得（UTC）
                const lastLoginDate = lastLogin.toDate();
                const now = new Date();
                
                // 日付を比較（年-月-日のみ）
                const lastLoginDay = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                // 最終ログインが今日より前なら受け取り可能
                const canClaim = lastLoginDay.getTime() < today.getTime();
                
                console.log('Login bonus check:', {
                    lastLoginDate: lastLoginDay.toISOString(),
                    today: today.toISOString(),
                    canClaim
                });
                
                return canClaim;
                
            } catch (error) {
                console.error('Check login bonus error:', error);
                return false;
            }
        }

        // ログインボーナスを受け取る
        async function claimLoginBonus() {
            try {
                // 再度チェック（二重受け取り防止）
                const canClaim = await checkLoginBonus();
                if (!canClaim) {
                    return { success: false, message: '今日のボーナスは既に受け取り済みです' };
                }
                
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                const userData = userDoc.data();
                const currentCoins = userData.coins || 0;
                const isAdminUser = userData.isAdmin || false;
                
                // 管理者は既に999999コインあるのでボーナス不要
                if (isAdminUser) {
                    // lastLoginだけ更新
                    await setDoc(doc(db, "users", auth.currentUser.uid), {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                    
                    return { success: true, message: '管理者は常に無限コインです', coins: 999999, bonus: 0 };
                }
                
                // 通常ユーザー: +100コイン + lastLogin更新
                await setDoc(doc(db, "users", auth.currentUser.uid), {
                    coins: currentCoins + 100,
                    lastLogin: serverTimestamp()
                }, { merge: true });
                
                return { success: true, message: '+100コイン獲得！', coins: currentCoins + 100, bonus: 100 };
                
            } catch (error) {
                console.error('Claim login bonus error:', error);
                return { success: false, message: 'エラーが発生しました: ' + error.message };
            }
        }

        // ログインボーナス画面を開く
        async function openLoginBonusModal() {
            $('#login-bonus-modal').removeClass('hidden');
            
            // 現在のコインを表示
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            const userData = userDoc.data();
            const currentCoins = userData.coins || 0;
            $('#bonus-current-coins').text(currentCoins.toLocaleString());
            
            // 受け取り状態をチェック
            const canClaim = await checkLoginBonus();
            
            if (canClaim) {
                // まだ受け取ってない
                $('#bonus-claim-section').removeClass('hidden');
                $('#bonus-already-claimed').addClass('hidden');
            } else {
                // 既に受け取り済み
                $('#bonus-claim-section').addClass('hidden');
                $('#bonus-already-claimed').removeClass('hidden');
            }
        }

        // ========== スロットマシン ==========
        const slotSymbols = ['🍒', '🍋', '🍊', '🍇', '⭐', '💎', '🎁'];
        const slotPayouts = {
            '🍒': 5,
            '🍋': 8,
            '🍊': 12,
            '🍇': 20,
            '⭐': 40,
            '💎': 100,
            '🎁': 0  // 強化スピン発動（配当なし）
        };
        let isSpinning = false;
        let hasSpecialSpin = false;
        let boostedSpinsRemaining = 0; // 強化スピン残り回数
        let currentBet = 1; // ベット倍率

        // ベット選択
        $('.bet-btn').on('click', function() {
            if (isSpinning) return;
            
            const newBet = parseInt($(this).data('bet'));
            
            // 強化スピン中にベット変更しようとした場合
            if (boostedSpinsRemaining > 0 && newBet !== currentBet) {
                if (!confirm(`🔥 強化スピン中です！\n\nベットを変更すると強化スピンが消えますがよろしいですか？\n\n残り: ${boostedSpinsRemaining}回`)) {
                    return; // キャンセル
                }
                // 「はい」を押した場合、強化スピンをリセット
                boostedSpinsRemaining = 0;
                updateBoostedSpinsDisplay();
            }
            
            $('.bet-btn').removeClass('active').css('border-color', '#666');
            $(this).addClass('active');
            currentBet = newBet;
            
            const cost = 10 * currentBet;
            $('#spin-btn-cost').text(`- ${cost} COINS -`);
            $('#bet-multiplier-text').text(`(×${currentBet})`);
            
            // 配当表を更新
            updatePayTable();
        });

        function updatePayTable() {
            const payouts = {
                '🍒': 5 * currentBet,
                '🍋': 8 * currentBet,
                '🍊': 12 * currentBet,
                '🍇': 20 * currentBet,
                '⭐': 40 * currentBet,
                '💎': 100 * currentBet
            };
            
            $('#pay-table').html(`
                🍒🍒🍒 → ×${5 * currentBet}  (${payouts['🍒'] * 10})<br>
                🍋🍋🍋 → ×${8 * currentBet}  (${payouts['🍋'] * 10})<br>
                🍊🍊🍊 → ×${12 * currentBet}  (${payouts['🍊'] * 10})<br>
                🍇🍇🍇 → ×${20 * currentBet}  (${payouts['🍇'] * 10})<br>
                ⭐⭐⭐ → ×${40 * currentBet}  (${payouts['⭐'] * 10})<br>
                💎💎💎 → ×${100 * currentBet}  (${payouts['💎'] * 10}) + SPECIAL!<br>
                🎁🎁🎁 → 🔥 BOOST x10 SPINS!
            `);
        }

        // リールストリップを初期化
        function initReelStrips() {
            for (let i = 1; i <= 3; i++) {
                const strip = $(`#strip${i}`);
                strip.empty();
                
                // 20個のシンボルを生成（ループ用）
                for (let j = 0; j < 20; j++) {
                    const symbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                    strip.append(`<div class="slot-symbol-item">${symbol}</div>`);
                }
                
                // 初期位置
                strip.css('top', '0px');
            }
        }

        // スロット画面を開く
        $('#openSlotBtn').on('click', async () => {
            $('#slot-modal').removeClass('hidden');
            initReelStrips();
            
            // コイン残高を更新
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            const coins = userDoc.data().coins || 0;
            $('#slot-coins').text(String(coins).padStart(4, '0'));
            $('#slot-result-display').addClass('hidden');
            
            if (hasSpecialSpin) {
                $('#special-spin-indicator').removeClass('hidden');
            } else {
                $('#special-spin-indicator').addClass('hidden');
            }
        });

        // スロットモーダルを閉じる（背景クリック）
        $('#slot-modal').on('click', function(e) {
            if (e.target === this) {
                $(this).addClass('hidden');
            }
        });

        // リールを回す（滑らかなアニメーション）
        function spinReel(reelId, targetSymbol, duration, hasReverse = false) {
            return new Promise((resolve) => {
                const strip = $(`#strip${reelId}`);
                const symbolHeight = 150;
                
                // ターゲットシンボルをストリップの適切な位置に配置
                const symbols = strip.find('.slot-symbol-item');
                const targetIndex = 10; // 真ん中あたり
                $(symbols[targetIndex]).text(targetSymbol);
                
                // 高速スピン開始
                let currentTop = 0;
                const spinSpeed = 50; // ms per frame
                const totalSpins = duration / spinSpeed;
                let frame = 0;
                
                const animate = () => {
                    frame++;
                    currentTop -= symbolHeight;
                    
                    // ループ処理
                    if (currentTop <= -symbolHeight * 15) {
                        currentTop = 0;
                    }
                    
                    // 停止前の演出
                    if (frame >= totalSpins - 10) {
                        // スローダウン
                        const slowFactor = (totalSpins - frame) / 10;
                        
                        if (hasReverse && frame === totalSpins - 5) {
                            // 通り過ぎて戻る演出
                            currentTop -= symbolHeight * 2;
                            setTimeout(() => {
                                const finalTop = -symbolHeight * targetIndex;
                                strip.css({
                                    'top': `${finalTop}px`,
                                    'transition': 'top 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                                });
                                setTimeout(() => {
                                    strip.css('transition', 'none');
                                    resolve();
                                }, 500);
                            }, 100);
                            return;
                        }
                    }
                    
                    if (frame < totalSpins) {
                        strip.css('top', `${currentTop}px`);
                        requestAnimationFrame(animate);
                    } else {
                        // 最終停止位置
                        const finalTop = -symbolHeight * targetIndex;
                        strip.css({
                            'top': `${finalTop}px`,
                            'transition': 'top 0.3s ease-out'
                        });
                        setTimeout(() => {
                            strip.css('transition', 'none');
                            resolve();
                        }, 300);
                    }
                };
                
                strip.css('transition', 'none');
                animate();
            });
        }

        // スピンボタン
        $('#spin-btn').on('click', async () => {
            if (isSpinning) return;
            
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            const currentCoins = userDoc.data().coins || 0;
            const betCost = 10 * currentBet;
            
            if (currentCoins < betCost) {
                alert(`❌ コインが足りません！（必要: ${betCost}コイン）`);
                return;
            }
            
            isSpinning = true;
            $('#spin-btn').prop('disabled', true).html('<div style="font-size:20px;">⏳ SPINNING...</div>');
            $('#reach-effect').addClass('hidden');
            $('#slot-result-display').addClass('hidden');
            
            // コイン消費
            await setDoc(doc(db, "users", auth.currentUser.uid), {
                coins: currentCoins - betCost
            }, { merge: true });
            
            $('#slot-coins').text(String(currentCoins - betCost).padStart(4, '0'));
            
            // 強化スピン中かチェック
            const isBoosted = boostedSpinsRemaining > 0;
            
            // 当たり確率
            // 通常: 18% / 強化スピン: 60%
            const winRate = isBoosted ? 0.60 : 0.18;
            const rand = Math.random();
            const willWin = rand < winRate;
            const willReachMiss = !willWin && rand < (winRate + 0.10); // +10%リーチ外れ
            let results;
            
            if (willWin) {
                // 当たり - シンボルは重み付け
                const symbolRand = Math.random();
                let winSymbol;
                
                // 強化スピン中はレアシンボルが出やすい
                if (isBoosted) {
                    if (symbolRand < 0.25) winSymbol = '🍒';      // 25%
                    else if (symbolRand < 0.45) winSymbol = '🍋'; // 20%
                    else if (symbolRand < 0.65) winSymbol = '🍊'; // 20%
                    else if (symbolRand < 0.82) winSymbol = '🍇'; // 17%
                    else if (symbolRand < 0.94) winSymbol = '⭐'; // 12%
                    else winSymbol = '💎';                         // 6%
                } else {
                    if (symbolRand < 0.33) winSymbol = '🍒';      // 33%
                    else if (symbolRand < 0.61) winSymbol = '🍋'; // 28%
                    else if (symbolRand < 0.78) winSymbol = '🍊'; // 17%
                    else if (symbolRand < 0.86) winSymbol = '🍇'; // 8%
                    else if (symbolRand < 0.92) winSymbol = '⭐'; // 6%
                    else if (symbolRand < 0.95) winSymbol = '💎'; // 3%
                    else winSymbol = '🎁';                         // 5% (強化スピン発動！)
                }
                
                results = [winSymbol, winSymbol, winSymbol];
            } else if (willReachMiss) {
                // リーチ外れ（2つ揃って3つ目が外れる）
                const reachSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                let missSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                while (missSymbol === reachSymbol) {
                    missSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                }
                results = [reachSymbol, reachSymbol, missSymbol];
            } else {
                // バラバラ
                results = [
                    slotSymbols[Math.floor(Math.random() * slotSymbols.length)],
                    slotSymbols[Math.floor(Math.random() * slotSymbols.length)],
                    slotSymbols[Math.floor(Math.random() * slotSymbols.length)]
                ];
                // 完全に揃わないようにする
                while (results[0] === results[1] && results[1] === results[2]) {
                    results[2] = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                }
            }
            
            // リールを順番に止める
            await spinReel(1, results[0], 1500, false);
            
            await new Promise(resolve => setTimeout(resolve, 200));
            await spinReel(2, results[1], 1800, false);
            
            // リーチ判定
            if (results[0] === results[1]) {
                $('#reach-effect').removeClass('hidden');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // 3つ目は演出強化（通り過ぎて戻る）
            const hasReverse = results[0] === results[1];
            await spinReel(3, results[2], 2200, hasReverse);
            
            $('#reach-effect').addClass('hidden');
            
            // 結果判定
            await new Promise(resolve => setTimeout(resolve, 300));
            checkSlotResult(results, currentCoins - betCost);
        });

        async function checkSlotResult(results, currentCoins) {
            const [r1, r2, r3] = results;
            
            // 強化スピンカウントダウン
            if (boostedSpinsRemaining > 0) {
                boostedSpinsRemaining--;
                updateBoostedSpinsDisplay();
            }
            
            if (r1 === r2 && r2 === r3) {
                // 🎁🎁🎁 = 強化スピン発動（コイン増えない）
                if (r1 === '🎁') {
                    boostedSpinsRemaining = 10;
                    updateBoostedSpinsDisplay();
                    $('#slot-result-display').addClass('hidden');
                    isSpinning = false;
                    const betCost = 10 * currentBet;
                    $('#spin-btn').prop('disabled', false).html(`<div style="font-size:24px; font-weight:bold;">🎰 SPIN</div><div style="font-size:12px; margin-top:5px;">- ${betCost} COINS -</div>`);
                    return;
                }
                
                let basePayout = slotPayouts[r1];
                let payout = basePayout * 10 * currentBet; // ベット倍率を適用
                
                if (hasSpecialSpin) {
                    payout *= 2;
                    hasSpecialSpin = false;
                    $('#special-spin-indicator').addClass('hidden');
                }
                
                if (r1 === '💎') {
                    hasSpecialSpin = true;
                    $('#special-spin-indicator').removeClass('hidden');
                }
                
                const newCoins = currentCoins + payout;
                await setDoc(doc(db, "users", auth.currentUser.uid), {
                    coins: newCoins
                }, { merge: true });
                
                $('#slot-coins').text(String(newCoins).padStart(4, '0'));
                $('#slot-win-amount').text(`+${String(payout).padStart(4, '0')}`);
                $('#slot-result-display').removeClass('hidden');
                
            } else if (r1 === r2 && r2 !== r3) {
                // リーチ外れ（強化スピンは発動しない）
                $('#slot-result-display').addClass('hidden');
                
            } else {
                $('#slot-result-display').addClass('hidden');
            }
            
            isSpinning = false;
            const betCost = 10 * currentBet;
            $('#spin-btn').prop('disabled', false).html(`<div style="font-size:24px; font-weight:bold;">🎰 SPIN</div><div style="font-size:12px; margin-top:5px;">- ${betCost} COINS -</div>`);
        }
        
        // 強化スピン表示更新
        function updateBoostedSpinsDisplay() {
            const $indicator = $('#boosted-spins-indicator');
            if (boostedSpinsRemaining > 0) {
                $indicator.text(`🔥 BOOSTED ×${boostedSpinsRemaining}`).removeClass('hidden');
            } else {
                $indicator.addClass('hidden');
            }
        }

        // ログインボーナスボタン
        $('#openLoginBonusBtn').on('click', openLoginBonusModal);

        // ログインボーナス受け取りボタン
        $('#claimBonusBtn').on('click', async () => {
            const $btn = $('#claimBonusBtn');
            $btn.prop('disabled', true).text('受け取り中...');
            
            const result = await claimLoginBonus();
            
            if (result.success) {
                // 成功アニメーション
                $('#bonus-amount').text(`+${result.bonus}`);
                $('#bonus-current-coins').text(result.coins.toLocaleString());
                
                // ボタンを非表示にして受け取り済み表示
                $('#bonus-claim-section').addClass('hidden');
                $('#bonus-already-claimed').removeClass('hidden');
                
                // 成功メッセージ
                setTimeout(() => {
                    alert('🎉 ' + result.message);
                }, 300);
            } else {
                alert('❌ ' + result.message);
                $btn.prop('disabled', false).text('受け取る');
            }
        });


        // ショップデータ読み込み
        async function loadShopData() {
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            const userData = userDoc.data();
            const userCoins = userData.coins || 0;
            const ownedItems = userData.ownedItems || [];
            const isAdminUser = userData.isAdmin || false;
            
            // プレビュー用に現在のユーザー情報を保存
            const currentUserName = userData.name || 'あなた';
            const currentUserPhoto = userData.photo || DEFAULT_AVATAR;
            
            // 管理者表示
            if (isAdminUser) {
                $('#user-coins').html('∞ <span style="font-size:14px; color:rgba(255,255,255,0.7);">(管理者)</span>');
            } else {
                $('#user-coins').text(userCoins);
            }
            
            const $container = $('#shop-items').empty();
            const $preview = $('#item-preview');
            
            shopItems.forEach(item => {
                const owned = ownedItems.includes(item.id);
                const canAfford = userCoins >= item.price;
                
                const $item = $(`
                    <div class="shop-item ${owned ? 'owned' : ''}" data-item-id="${item.id}" onclick="${owned ? '' : `purchaseItem('${item.id}')`}">
                        <div class="shop-item-icon">${item.icon}</div>
                        <div class="shop-item-name">${item.name}</div>
                        ${owned ? 
                            '<div class="shop-item-owned">✅ 所持中</div>' :
                            `<div class="shop-item-price">💰 ${item.price}</div>`
                        }
                    </div>
                `);
                
                // ホバーでプレビュー表示
                $item.on('mouseenter', function() {
                    showItemPreview(item, currentUserName, currentUserPhoto);
                });
                
                $container.append($item);
            });
            
            // プレビューエリアから出た時だけ非表示
            let previewTimeout;
            $container.on('mouseleave', function() {
                previewTimeout = setTimeout(() => {
                    if (!$preview.is(':hover')) {
                        $preview.addClass('hidden');
                    }
                }, 200);
            });
            
            $preview.on('mouseenter', function() {
                clearTimeout(previewTimeout);
            });
            
            $preview.on('mouseleave', function() {
                $preview.addClass('hidden');
            });
        }

        // アイテムプレビュー表示
        function showItemPreview(item, userName, userPhoto) {
            $('#item-preview').removeClass('hidden');
            $('#preview-item-name').text(item.name);
            $('#preview-item-desc').text(item.description);
            $('#preview-name').text(userName);
            $('#preview-icon').attr('src', userPhoto);
            
            // プレビューメッセージのクラスをリセット（全エフェクト）
            $('#preview-message').removeClass('effect-fire effect-sparkle effect-lightning effect-rainbow effect-shadow effect-ice effect-toxic effect-gold');
            $('#preview-icon-container').removeClass('effect-fire effect-sparkle effect-lightning effect-rainbow effect-shadow effect-ice effect-toxic effect-gold');
            $('#preview-badge').empty();
            
            // アイテムタイプに応じてプレビュー
            if (item.id === 'vip_badge' || item.id === 'star_badge' || item.id === 'crown_badge') {
                // バッジプレビュー
                const badgeMap = {
                    'vip_badge': { icon: '👑', title: 'VIP' },
                    'star_badge': { icon: '⭐', title: 'スター' },
                    'crown_badge': { icon: '👸', title: 'プレミアム' }
                };
                const badge = badgeMap[item.id];
                $('#preview-badge').html(`<span class="user-badge" title="${badge.title}">${badge.icon}</span>`);
                
            } else if (item.id === 'fire_effect') {
                $('#preview-message').addClass('effect-fire');
                
            } else if (item.id === 'sparkle_effect') {
                $('#preview-message').addClass('effect-sparkle');
                
            } else if (item.id === 'lightning_effect') {
                $('#preview-message').addClass('effect-lightning');
                
            } else if (item.id === 'rainbow_effect') {
                $('#preview-message').addClass('effect-rainbow');
                
            } else if (item.id === 'shadow_effect') {
                $('#preview-message').addClass('effect-shadow');
                
            } else if (item.id === 'ice_effect') {
                $('#preview-message').addClass('effect-ice');
                
            } else if (item.id === 'toxic_effect') {
                $('#preview-message').addClass('effect-toxic');
                
            } else if (item.id === 'gold_effect') {
                $('#preview-message').addClass('effect-gold');
                
            } else if (item.id === 'rainbow_theme' || item.id === 'heart_theme') {
                // テーマプレビュー（説明のみ）
                $('#preview-badge').html(`<span style="font-size:12px; color:var(--txt-m);">画面全体の背景が変わります</span>`);
            }
        }

        // アイテム購入
        window.purchaseItem = async (itemId) => {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            if (!confirm(`${item.icon} ${item.name}\n${item.description}\n\n💰 ${item.price}コインで購入しますか？`)) {
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                const userData = userDoc.data();
                const userCoins = userData.coins || 0;
                const ownedItems = userData.ownedItems || [];
                
                if (userCoins < item.price) {
                    alert('❌ コインが足りません！');
                    return;
                }
                
                if (ownedItems.includes(itemId)) {
                    alert('✅ すでに所持しています！');
                    return;
                }
                
                // 購入処理
                await setDoc(doc(db, "users", auth.currentUser.uid), {
                    coins: userCoins - item.price,
                    ownedItems: arrayUnion(itemId)
                }, { merge: true });
                
                alert(`🎉 ${item.name}を購入しました！`);
                
                // テーマアイテムを購入した場合、即座に適用
                if (itemId === 'rainbow_theme' || itemId === 'heart_theme') {
                    applyUserTheme();
                    alert(`✨ テーマが適用されました！\n\n※ 複数のテーマを持っている場合、\n最後に購入したものが優先されます。`);
                }
                
                loadShopData();
                
            } catch (error) {
                console.error('Purchase error:', error);
                alert('❌ 購入に失敗しました: ' + error.message);
            }
        };


        // ショップボタン（ヘッダー + 旧メニュー内）
        $('#openShopBtnHeader, #openShopBtn').on('click', () => {
            $('#other-settings-modal').addClass('hidden');
            $('#shop-modal').removeClass('hidden');
            loadShopData();
        });

        // 通知ボタン（設定モーダル内）
        $('#toggleNotificationBtn').on('click', async () => {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationsEnabled = !notificationsEnabled;
                    localStorage.setItem('chat_notifications_enabled', notificationsEnabled);
                    updateNotificationButtonUI();
                } else if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        localStorage.setItem('chat_notifications_enabled', 'true');
                        updateNotificationButtonUI();
                    }
                } else {
                    alert('ブラウザの設定で通知を許可してください');
                }
            }
        });

        function updateNotificationButtonUI() {
            const $btn = $('#toggleNotificationBtn');
            const $text = $('#notificationBtnText');
            const $icon = $btn.find('.material-symbols-outlined');
            
            if (notificationsEnabled) {
                $btn.removeClass('btn-toggle-off').addClass('btn-toggle-on');
                $text.text('通知: ON');
                $icon.text('notifications');
            } else {
                $btn.removeClass('btn-toggle-on').addClass('btn-toggle-off');
                $text.text('通知: OFF');
                $icon.text('notifications_off');
            }
        }

        window.react = async (id, emoji, currentJson) => {
            const colRef = currentRoomId ? collection(db, "rooms", currentRoomId, "messages") : collection(db, "chats");
            const users = (currentJson && currentJson[emoji]) || [];
            await updateDoc(doc(colRef, id), { [`reactions.${emoji}`]: users.includes(auth.currentUser.uid) ? arrayRemove(auth.currentUser.uid) : arrayUnion(auth.currentUser.uid) });
        };

        // リアクションピッカーの絵文字リスト
        const reactionEmojis = [
            '👍', '❤️', '😂', '😮', '😢', '😡',
            '🙏', '👏', '🎉', '🔥', '✨', '💯',
            '👀', '🤔', '😅', '😊', '🥰', '😎',
            '🤩', '😇', '🤗', '🙌', '✅', '❌',
            '⭐', '💪', '👌', '🎊', '🎈', '💕'
        ];

        window.openReactionPicker = (msgId, event, currentReactions) => {
            event.stopPropagation();
            const $picker = $('#reaction-picker');
            
            // 絵文字を配置
            $picker.empty();
            reactionEmojis.forEach(emoji => {
                $picker.append(`<div class="reaction-emoji" onclick="react('${msgId}', '${emoji}', ${JSON.stringify(currentReactions).replace(/"/g, '&quot;')}); $('#reaction-picker').addClass('hidden');">${emoji}</div>`);
            });
            
            // 一旦表示して実際のサイズを取得
            $picker.css({ left: '0px', top: '0px', visibility: 'hidden' }).removeClass('hidden');
            const pickerWidth = $picker.outerWidth();
            const pickerHeight = $picker.outerHeight();
            $picker.addClass('hidden').css('visibility', 'visible');
            
            // ピッカーの位置を計算
            const rect = event.target.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const padding = 10; // 画面端からの余白
            
            let left = rect.left;
            let top = rect.bottom + 5;
            
            // 右端チェック
            if (left + pickerWidth > windowWidth - padding) {
                left = windowWidth - pickerWidth - padding;
            }
            // 左端チェック
            if (left < padding) {
                left = padding;
            }
            
            // 下端チェック（画面下に収まらない場合は上に表示）
            if (top + pickerHeight > windowHeight - padding) {
                top = rect.top - pickerHeight - 5;
            }
            // 上端チェック
            if (top < padding) {
                top = padding;
            }
            
            $picker.css({ left: left + 'px', top: top + 'px' }).removeClass('hidden');
        };

        // ピッカー外をクリックしたら閉じる
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#reaction-picker, .op-btn').length) {
                $('#reaction-picker').addClass('hidden');
            }
        });

        window.deleteMsg = async (id) => {
            if(confirm("このメッセージを削除しますか？")) {
                const colRef = currentRoomId ? collection(db, "rooms", currentRoomId, "messages") : collection(db, "chats");
                await deleteDoc(doc(colRef, id));
            }
        };

        window.setEdit = (id, text) => {
            editTargetId = id;
            $("#messageInput").val(text).focus();
            $("#edit-indicator").removeClass("hidden");
            $("#reply-preview").addClass("hidden");
            replyTarget = null;
        };
        window.cancelEdit = () => { editTargetId = null; $("#messageInput").val(""); $("#edit-indicator").addClass("hidden"); };
        $("#cancel-edit").on("click", cancelEdit);

        $("#sendBtn").on("click", send);
        $("#messageInput").on("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } });
        $("#imgBtn").on("click", () => $("#real_file_input").click());
        $("#stampBtn").on("click", () => $("#stamp-modal").removeClass("hidden"));
        
        $("#real_file_input").on("change", (e) => uploadImageFile(e.target.files[0]));
        $("#real_avatar_input").on("change", (e) => uploadAvatarFile(e.target.files[0]));
        $("#real_banner_input").on("change", (e) => uploadBannerFile(e.target.files[0]));
        $("#remove-img-btn").on("click", () => { pendingImageUrl = null; $("#upload-preview-container").addClass("hidden"); });

        window.setReply = (id, name, text) => { 
            cancelEdit();
            replyTarget = { id, name, text: text.substring(0, 20) + "..." }; 
            $("#reply-user-p").text(name); $("#reply-preview").removeClass("hidden"); $("#messageInput").focus(); 
        };
        $("#cancel-reply").on("click", () => { replyTarget = null; $("#reply-preview").addClass("hidden"); });
        window.scrollToMsg = (id) => { document.getElementById(`msg-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); };

        window.showProfile = async (uid) => {
            const snap = await getDoc(doc(db, "users", uid)); 
            if (!snap.exists()) return;
            const d = snap.data(); 
            
            // 基本情報
            $("#viewName").text(d.name || "ゲスト"); 
            $("#viewAvatar").attr("src", d.photo || DEFAULT_AVATAR); 
            $("#viewBanner").attr("src", d.banner || DEFAULT_BANNER); 
            $("#viewBio").text(d.bio || "No bio.");
            
            // オンライン状態
            const statusClass = d.status === 'online' ? 'online' : 'offline';
            $("#viewStatusDot").removeClass('online offline').addClass(statusClass);
            
            // エフェクト適用
            const equipped = d.equipped || {};
            $("#viewAvatarContainer").removeClass('effect-fire effect-sparkle effect-lightning effect-rainbow effect-shadow effect-ice effect-toxic effect-gold');
            
            if (equipped.effect === 'fire_effect') $("#viewAvatarContainer").addClass('effect-fire');
            else if (equipped.effect === 'sparkle_effect') $("#viewAvatarContainer").addClass('effect-sparkle');
            else if (equipped.effect === 'lightning_effect') $("#viewAvatarContainer").addClass('effect-lightning');
            else if (equipped.effect === 'rainbow_effect') $("#viewAvatarContainer").addClass('effect-rainbow');
            else if (equipped.effect === 'shadow_effect') $("#viewAvatarContainer").addClass('effect-shadow');
            else if (equipped.effect === 'ice_effect') $("#viewAvatarContainer").addClass('effect-ice');
            else if (equipped.effect === 'toxic_effect') $("#viewAvatarContainer").addClass('effect-toxic');
            else if (equipped.effect === 'gold_effect') $("#viewAvatarContainer").addClass('effect-gold');
            
            // バッジ表示
            const $badges = $("#viewBadges").empty();
            if (equipped.badge === 'vip_badge') {
                $badges.append('<span class="user-badge" title="VIP">👑</span>');
            } else if (equipped.badge === 'star_badge') {
                $badges.append('<span class="user-badge" title="スター">⭐</span>');
            } else if (equipped.badge === 'crown_badge') {
                $badges.append('<span class="user-badge" title="プレミアム">👸</span>');
            }
            
            // アクションボックス
            const $actionBox = $("#prof-action-box").empty();
            if (uid !== auth.currentUser.uid) {
                const reqId = [auth.currentUser.uid, uid].sort().join("_");
                const rSnap = await getDoc(doc(db, "friendRequests", reqId));
                if (!rSnap.exists()) $actionBox.append(`<button onclick="sendRequest('${uid}')" class="btn-sm" style="background:var(--accent);">申請</button>`);
                else if (rSnap.data().status === "accepted") {
                    $actionBox.append(`<button onclick="openDM('${uid}','${escapeHTML(d.name || "ゲスト").replace(/'/g, "\\'")}')" class="btn-sm" style="background:var(--success);">DMを送る</button>`);
                    $actionBox.append(`<span style="color:var(--friend-gold); font-size:12px; margin-left:10px;">★</span>`);
                }
            }
            $("#prof-modal").removeClass("hidden");
        };

        window.openDM = async (otherUid, otherName) => {
            const roomId = [auth.currentUser.uid, otherUid].sort().join("_");
            await setDoc(doc(db, "rooms", roomId), { users: [auth.currentUser.uid, otherUid] }, { merge: true });
            $("#prof-modal, #user-list-modal").addClass("hidden");
            toggleSidebar(false);
            switchChat(roomId, otherName);
        };

        $("#my-profile-trigger").on("click", async () => {
            const snap = await getDoc(doc(db, "users", auth.currentUser.uid));
            if (snap.exists()) { 
                const d = snap.data(); 
                $("#editName").val(d.name); 
                $("#editPhoto").val(d.photo); 
                $("#editBanner").val(d.banner); 
                $("#editBio").val(d.bio);
                
                // アイテム装備の選択肢を読み込む
                await loadEquipmentOptions(d);
            }
            syncProfilePreview(); 
            $("#settings-modal").removeClass("hidden");
        });

        // アイテム装備の選択肢を読み込む
        async function loadEquipmentOptions(userData) {
            const ownedItems = userData.ownedItems || [];
            const equipped = userData.equipped || {};
            
            // バッジの選択肢
            const $badgeSelect = $('#editEquippedBadge').empty();
            $badgeSelect.append('<option value="">なし</option>');
            if (ownedItems.includes('vip_badge')) $badgeSelect.append('<option value="vip_badge">👑 VIPバッジ</option>');
            if (ownedItems.includes('star_badge')) $badgeSelect.append('<option value="star_badge">⭐ スターバッジ</option>');
            if (ownedItems.includes('crown_badge')) $badgeSelect.append('<option value="crown_badge">👸 クラウンバッジ</option>');
            $badgeSelect.val(equipped.badge || '');
            
            // テーマの選択肢
            const $themeSelect = $('#editEquippedTheme').empty();
            $themeSelect.append('<option value="">デフォルト</option>');
            if (ownedItems.includes('rainbow_theme')) $themeSelect.append('<option value="rainbow_theme">🌈 レインボーテーマ</option>');
            if (ownedItems.includes('heart_theme')) $themeSelect.append('<option value="heart_theme">💕 ハートテーマ</option>');
            $themeSelect.val(equipped.theme || '');
            
            // エフェクトの選択肢
            const $effectSelect = $('#editEquippedEffect').empty();
            $effectSelect.append('<option value="">なし</option>');
            if (ownedItems.includes('fire_effect')) $effectSelect.append('<option value="fire_effect">🔥 炎エフェクト</option>');
            if (ownedItems.includes('sparkle_effect')) $effectSelect.append('<option value="sparkle_effect">✨ キラキラエフェクト</option>');
            if (ownedItems.includes('lightning_effect')) $effectSelect.append('<option value="lightning_effect">⚡ 稲妻エフェクト</option>');
            if (ownedItems.includes('rainbow_effect')) $effectSelect.append('<option value="rainbow_effect">🌟 虹色エフェクト</option>');
            if (ownedItems.includes('shadow_effect')) $effectSelect.append('<option value="shadow_effect">🌑 シャドウエフェクト</option>');
            if (ownedItems.includes('ice_effect')) $effectSelect.append('<option value="ice_effect">❄️ 氷エフェクト</option>');
            if (ownedItems.includes('toxic_effect')) $effectSelect.append('<option value="toxic_effect">☠️ 毒エフェクト</option>');
            if (ownedItems.includes('gold_effect')) $effectSelect.append('<option value="gold_effect">💛 ゴールドエフェクト</option>');
            $effectSelect.val(equipped.effect || '');
        }

        $("#saveProfile").on("click", async () => {
            const data = { 
                name: $("#editName").val(), 
                photo: $("#editPhoto").val(), 
                banner: $("#editBanner").val(), 
                bio: $("#editBio").val(),
                equipped: {
                    badge: $("#editEquippedBadge").val(),
                    theme: $("#editEquippedTheme").val(),
                    effect: $("#editEquippedEffect").val()
                }
            };
            await updateProfile(auth.currentUser, { displayName: data.name, photoURL: data.photo });
            await setDoc(doc(db, "users", auth.currentUser.uid), data, { merge: true });
            
            // テーマを即座に適用
            applyUserTheme();
            
            location.reload();
        });

        window.switchUserTab = (tab) => { 
            currentTab = tab; 
            $(".tab-btn").removeClass("active"); 
            if(tab === 'all') $(".tab-btn:contains('すべて')").addClass("active");
            else if(tab === 'friends') $(".tab-btn:contains('フレンド')").addClass("active");
            else if(tab === 'requests') {
                $(".tab-btn:contains('申請')").addClass("active");
                // 申請タブを開いたら、フレンド申請の未読をクリア
                clearFriendRequestUnread();
            }
            loadUserList(); 
        };
        
        // フレンド申請の未読をクリアする関数
        function clearFriendRequestUnread() {
            // friend_request_で始まるキーを全て削除
            Object.keys(unreadRooms).forEach(key => {
                if(key.startsWith('friend_request_')) {
                    delete unreadRooms[key];
                }
            });
            recalculateTotalUnread();
            console.log("Cleared friend request notifications");
        }
        window.loadUserList = () => {
            onSnapshot(collection(db, "friendRequests"), (reqSnap) => {
                const reqMap = {}; 
                let pendingRequestCount = 0;
                
                reqSnap.forEach(d => {
                    reqMap[d.id] = d.data();
                    // 自分宛ての未承認申請をカウント
                    const data = d.data();
                    if (data.to === auth.currentUser.uid && data.status === "pending") {
                        pendingRequestCount++;
                    }
                });
                
                // 申請タブのバッジを更新
                const $badge = $("#request-count-badge");
                if (pendingRequestCount > 0) {
                    $badge.text(pendingRequestCount).show();
                } else {
                    $badge.hide();
                }
                
                onSnapshot(collection(db, "users"), (userSnap) => {
                    const $list = $("#user-list-container").empty();
                    
                    // 「申請」タブの場合
                    if (currentTab === 'requests') {
                        let hasRequests = false;
                        
                        // 受信した申請を表示
                        $list.append('<div style="padding:10px; font-weight:bold; color:var(--txt-m); font-size:12px; border-bottom:1px solid var(--bg-38);">受信した申請</div>');
                        Object.entries(reqMap).forEach(([reqId, reqData]) => {
                            if (reqData.to === auth.currentUser.uid && reqData.status === "pending") {
                                hasRequests = true;
                                const senderDoc = userSnap.docs.find(doc => doc.id === reqData.from);
                                if (senderDoc) {
                                    const d = senderDoc.data();
                                    const uid = senderDoc.id;
                                    const safeName = escapeHTML(d.name || "ゲスト");
                                    const isOnline = d.status === "online";
                                    const isGuest = d.name === "ゲスト" || d.isAnonymous === true;
                                    const guestLabel = isGuest ? '<span style="background:var(--bg-38); color:var(--txt-m); font-size:10px; padding:2px 6px; border-radius:3px; margin-left:5px;">ゲスト</span>' : '';
                                    
                                    $list.append(`<div class="user-item" data-uid="${uid}">
                                        <div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="showProfile('${uid}')">
                                            <div class="icon-container">
                                                <img src="${d.photo || DEFAULT_AVATAR}" style="width:30px;height:30px;border-radius:50%">
                                                <div class="status-dot ${isOnline?'online':'offline'}"></div>
                                            </div>
                                            <span>${safeName}${guestLabel}</span>
                                        </div>
                                        <div>
                                            <button onclick="acceptRequest('${reqId}')" class="btn-sm" style="background:var(--success);">承認</button>
                                            <button onclick="removeFriend('${reqId}')" class="btn-sm" style="background:var(--danger); color:white;">拒否</button>
                                        </div>
                                    </div>`);
                                }
                            }
                        });
                        
                        if (!hasRequests) {
                            $list.append('<div style="padding:20px; text-align:center; color:var(--txt-m); font-size:14px;">受信した申請はありません</div>');
                        }
                        
                        // 送信した申請を表示
                        $list.append('<div style="padding:10px; font-weight:bold; color:var(--txt-m); font-size:12px; border-bottom:1px solid var(--bg-38); margin-top:15px;">送信した申請</div>');
                        let hasSentRequests = false;
                        
                        Object.entries(reqMap).forEach(([reqId, reqData]) => {
                            if (reqData.from === auth.currentUser.uid && reqData.status === "pending") {
                                hasSentRequests = true;
                                const targetDoc = userSnap.docs.find(doc => doc.id === reqData.to);
                                if (targetDoc) {
                                    const d = targetDoc.data();
                                    const uid = targetDoc.id;
                                    const safeName = escapeHTML(d.name || "ゲスト");
                                    const isOnline = d.status === "online";
                                    
                                    $list.append(`<div class="user-item" data-uid="${uid}">
                                        <div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="showProfile('${uid}')">
                                            <div class="icon-container">
                                                <img src="${d.photo || DEFAULT_AVATAR}" style="width:30px;height:30px;border-radius:50%">
                                                <div class="status-dot ${isOnline?'online':'offline'}"></div>
                                            </div>
                                            <span>${safeName}</span>
                                        </div>
                                        <div>
                                            <span style="color:var(--txt-m); font-size:12px;">申請中</span>
                                            <button onclick="removeFriend('${reqId}')" class="btn-sm" style="background:var(--bg-2b); color:var(--danger); margin-left:5px;">取消</button>
                                        </div>
                                    </div>`);
                                }
                            }
                        });
                        
                        if (!hasSentRequests) {
                            $list.append('<div style="padding:20px; text-align:center; color:var(--txt-m); font-size:14px;">送信した申請はありません</div>');
                        }
                        
                        return; // 申請タブの処理はここで終了
                    }
                    
                    // 「すべて」「フレンド」タブの処理（既存のロジック）
                    userSnap.forEach((uDoc) => {
                        const uid = uDoc.id; if (uid === auth.currentUser.uid) return;
                        const d = uDoc.data();
                        
                        // 匿名ユーザーまたは「ゲスト」という名前のユーザーを除外
                        if (d.isAnonymous === true) return;
                        if (d.name === "ゲスト") return;
                        
                        const isOnline = d.status === "online"; const reqId = [auth.currentUser.uid, uid].sort().join("_"); const req = reqMap[reqId];
                        const safeName = escapeHTML(d.name || "ゲスト");
                        let btn = `<button onclick="sendRequest('${uid}')" class="btn-sm" style="background:var(--accent);">申請</button>`;
                        let isF = false;
                        if (req) {
                            if (req.status === "accepted") { 
                                btn = `<button onclick="openDM('${uid}','${safeName.replace(/'/g, "\\'")}')" class="btn-sm" style="background:var(--success);">DM</button>`; 
                                btn += `<button onclick="removeFriend('${reqId}')" class="btn-sm" style="background:var(--bg-2b); color:var(--danger);">解除</button>`;
                                isF = true; 
                            }
                            else if (req.from === auth.currentUser.uid) btn = `<span style="color:var(--txt-m); font-size:12px;">申請中</span>`;
                            else btn = `<button onclick="acceptRequest('${reqId}')" class="btn-sm" style="background:var(--success);">承認</button>`;
                        }
                        if (currentTab === 'friends' && !isF) return;
                        $list.append(`<div class="user-item" data-uid="${uid}"><div style="display:flex;align-items:center;gap:10px;cursor:pointer;" onclick="showProfile('${uid}')"><div class="icon-container"><img src="${d.photo || DEFAULT_AVATAR}" style="width:30px;height:30px;border-radius:50%"><div class="status-dot ${isOnline?'online':'offline'}"></div></div><span style="${isF?'color:var(--friend-gold);font-weight:bold;':''}">${safeName}</span></div><div>${btn}</div></div>`);
                    });
                });
            });
        };
        window.sendRequest = async (uid) => { 
            // ゲストユーザーは申請できない
            if (auth.currentUser.isAnonymous || auth.currentUser.displayName === "ゲスト") {
                alert("フレンド機能を使うには、メールアドレスでログインしてください。\n\n右上のメニュー → ログアウト → メールでログイン");
                return;
            }
            const id = [auth.currentUser.uid, uid].sort().join("_"); 
            await setDoc(doc(db, "friendRequests", id), { from: auth.currentUser.uid, to: uid, status: "pending" }); 
        };
        window.acceptRequest = async (id) => { await updateDoc(doc(db, "friendRequests", id), { status: "accepted" }); };
        window.removeFriend = async (id) => { if (confirm("解除しますか？")) await deleteDoc(doc(db, "friendRequests", id)); };

        async function setupWebRTC() {
            pc = new RTCPeerConnection(servers);
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            $("#localVideo")[0].srcObject = localStream;
            pc.ontrack = (e) => { $("#remoteVideo")[0].srcObject = e.streams[0]; };
            $("#call-overlay").removeClass("hidden");
        }
        window.startCall = async () => {
            $("#other-settings-modal").addClass("hidden"); await setupWebRTC();
            const callDoc = doc(collection(db, "calls")); currentCallId = callDoc.id;
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            await setDoc(callDoc, { offer: { type: offer.type, sdp: offer.sdp }, caller: auth.currentUser.displayName });
            onSnapshot(callDoc, (s) => { if (!pc.currentRemoteDescription && s.data()?.answer) pc.setRemoteDescription(new RTCSessionDescription(s.data().answer)); });
        };
        function listenForCalls() {
            onSnapshot(collection(db, "calls"), (snap) => {
                snap.docChanges().forEach(async (change) => {
                    const data = change.doc.data();
                    if (change.type === "added" && data.offer && !data.answer && data.caller !== auth.currentUser.displayName) {
                        currentCallId = change.doc.id; await setupWebRTC();
                        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
                        await updateDoc(doc(db, "calls", currentCallId), { answer: { type: answer.type, sdp: answer.sdp } });
                    }
                });
            });
        }
        const setOnline = async () => {
            if (auth.currentUser) {
                try {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { status: "online", lastSeen: serverTimestamp() });
                } catch (e) { console.log("Status update error (online)"); }
            }
        };

        const setOffline = async () => {
            if (auth.currentUser) {
                try {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { status: "offline", lastSeen: serverTimestamp(), isTyping: false });
                } catch (e) { console.log("Status update error (offline)"); }
            }
        };

        $("#loginBtn").on("click", async () => {
            const e = $("#email").val(), p = $("#password").val();
            try { await signInWithEmailAndPassword(auth, e, p); }
            catch { const res = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, "users", res.user.uid), { name: "ゲスト", photo: DEFAULT_AVATAR, status: "online", isTyping: false, isAnonymous: false }); }
            location.reload();
        });
        
        $("#guestBtn").on("click", async () => {
            try { await signInAnonymously(auth); location.reload(); }
            catch (e) { alert("ゲストログインエラー: " + e.message); }
        });
        
        const doLogout = async () => { 
            await setOffline();
            signOut(auth).then(() => location.reload()); 
        };

        $("#logoutBtn, #logoutBtnSide").on("click", doLogout);
        $("#openOtherSettings").on("click", () => $("#other-settings-modal").removeClass("hidden"));

        // --- イベント監視追加: タブ表示時・フォーカス時、ユーザー操作時に未読クリア ---
        // モバイル対応: オフライン検知の強化（iOS & Android）
        let onlineStatusInterval;
        let lastActivityTime = Date.now();
        let offlineCheckInterval;
        
        const ensureOnlineStatus = () => {
            if (auth.currentUser && document.visibilityState === "visible") {
                setOnline();
                lastActivityTime = Date.now();
            }
        };
        
        const ensureOfflineStatus = () => {
            if (auth.currentUser) {
                setOffline();
            }
        };

        // iOS Safari: 非アクティブ検知の強化
        const checkInactivity = () => {
            const now = Date.now();
            // 10秒以上更新がなく、非表示状態ならオフライン
            if (now - lastActivityTime > 10000 && document.visibilityState === "hidden") {
                ensureOfflineStatus();
            }
        };

        // 全ブラウザ対応: visibilitychange（標準）
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                setOnline();
                lastActivityTime = Date.now();
                
                // アクティブな間は定期的にオンライン状態を更新
                if (onlineStatusInterval) clearInterval(onlineStatusInterval);
                onlineStatusInterval = setInterval(ensureOnlineStatus, 5000);
                
                if (document.hasFocus()) clearUnread();
            } else {
                // バックグラウンドに入ったら即座にオフライン
                if (onlineStatusInterval) clearInterval(onlineStatusInterval);
                ensureOfflineStatus();
                
                // Windows Chrome対策: 複数回念押し
                setTimeout(() => {
                    if (document.visibilityState === "hidden" || document.hidden) {
                        ensureOfflineStatus();
                    }
                }, 50);
                
                setTimeout(() => {
                    if (document.visibilityState === "hidden" || document.hidden) {
                        ensureOfflineStatus();
                    }
                }, 200);
                
                setTimeout(() => {
                    if (document.visibilityState === "hidden" || document.hidden) {
                        ensureOfflineStatus();
                    }
                }, 500);
                
                setTimeout(checkInactivity, 2000);
            }
        }, true); // capture phase
        
        // Windows Chrome専用: document.hidden の直接監視
        let lastHiddenState = document.hidden;
        setInterval(() => {
            const currentHidden = document.hidden;
            if (currentHidden !== lastHiddenState) {
                lastHiddenState = currentHidden;
                if (currentHidden) {
                    ensureOfflineStatus();
                } else {
                    setOnline();
                    lastActivityTime = Date.now();
                }
            }
        }, 500); // 0.5秒ごとに状態チェック
        
        // Firefox対応: mozvisibilitychange
        document.addEventListener("mozvisibilitychange", () => {
            if (document.mozHidden) {
                ensureOfflineStatus();
            } else {
                setOnline();
                lastActivityTime = Date.now();
            }
        });
        
        // 古いIE/Edge対応: msvisibilitychange
        document.addEventListener("msvisibilitychange", () => {
            if (document.msHidden) {
                ensureOfflineStatus();
            } else {
                setOnline();
                lastActivityTime = Date.now();
            }
        });
        
        // WebKit系（Safari）対応: webkitvisibilitychange
        document.addEventListener("webkitvisibilitychange", () => {
            if (document.webkitHidden) {
                ensureOfflineStatus();
            } else {
                setOnline();
                lastActivityTime = Date.now();
            }
        });
        
        // focus/blur イベント
        window.addEventListener("focus", () => {
            setOnline();
            lastActivityTime = Date.now();
            clearUnread();
        });
        
        window.addEventListener("blur", () => {
            // Windows Chrome: 即座にオフライン判定
            ensureOfflineStatus();
            
            // 念のため複数回チェック
            setTimeout(() => {
                if (document.visibilityState === "hidden" || !document.hasFocus() || document.hidden) {
                    ensureOfflineStatus();
                }
            }, 100);
            
            setTimeout(() => {
                if (document.visibilityState === "hidden" || !document.hasFocus() || document.hidden) {
                    ensureOfflineStatus();
                }
            }, 300);
        }, true); // capture phase
        
        // ユーザーアクションで未読クリア & アクティブ記録
        window.addEventListener("mousemove", () => { 
            lastActivityTime = Date.now();
            if(document.hasFocus()) clearUnread(); 
        });
        window.addEventListener("click", () => { 
            lastActivityTime = Date.now();
            clearUnread(); 
        });
        window.addEventListener("keydown", () => { 
            lastActivityTime = Date.now();
            clearUnread(); 
        });
        
        // タッチイベント（モバイル対応）
        let lastTouchTime = 0;
        window.addEventListener("touchstart", () => {
            const now = Date.now();
            lastActivityTime = now;
            
            // タッチイベントの重複を防ぐ
            if (now - lastTouchTime > 100) {
                setOnline();
                clearUnread();
                lastTouchTime = now;
            }
        }, { passive: true });
        
        // iOS Safari: スクロール時もアクティブと見なす
        window.addEventListener("scroll", () => {
            lastActivityTime = Date.now();
        }, { passive: true });
        // --------------------------------------------------------

        // ページ離脱時の処理（iOS Safari対策を強化）
        window.addEventListener("pagehide", (e) => {
            if (onlineStatusInterval) clearInterval(onlineStatusInterval);
            ensureOfflineStatus();
            
            // iOS Safari: navigator.sendBeacon で確実に送信
            if (navigator.sendBeacon && auth.currentUser) {
                const offlineData = JSON.stringify({
                    uid: auth.currentUser.uid,
                    status: 'offline',
                    timestamp: Date.now()
                });
                // Firestoreには送れないが、ログとして記録
                console.log('pagehide: Setting offline', offlineData);
            }
        }, { capture: true });
        
        window.addEventListener("beforeunload", (e) => {
            if (onlineStatusInterval) clearInterval(onlineStatusInterval);
            if (offlineCheckInterval) clearInterval(offlineCheckInterval);
            ensureOfflineStatus();
            
            // 念押しでFirestoreに直接書き込み
            if (auth.currentUser) {
                const userRef = doc(db, "users", auth.currentUser.uid);
                setDoc(userRef, { status: 'offline' }, { merge: true }).catch(() => {});
            }
        }, { capture: true });
        
        window.addEventListener("unload", (e) => {
            if (auth.currentUser) {
                const userRef = doc(db, "users", auth.currentUser.uid);
                setDoc(userRef, { status: 'offline' }, { merge: true }).catch(() => {});
            }
        }, { capture: true });
        
        // iOS Safari専用: 追加のライフサイクルイベント
        if ('onfreeze' in window) {
            window.addEventListener("freeze", () => {
                if (onlineStatusInterval) clearInterval(onlineStatusInterval);
                ensureOfflineStatus();
            }, { capture: true });
        }
        
        if ('onresume' in window) {
            window.addEventListener("resume", () => {
                setOnline();
                lastActivityTime = Date.now();
            }, { capture: true });
        }

        // iOS PWA対策: App切り替え検知
        if (window.navigator.standalone) {
            document.addEventListener("webkitvisibilitychange", () => {
                if (document.webkitHidden) {
                    ensureOfflineStatus();
                } else {
                    setOnline();
                    lastActivityTime = Date.now();
                }
            });
        }

        // フォールバック: 定期的にチェック（全ブラウザ対応）
        // イベントが発火しないブラウザ用の最終手段
        offlineCheckInterval = setInterval(() => {
            if (auth.currentUser) {
                const now = Date.now();
                const isHidden = document.hidden || document.mozHidden || document.webkitHidden || document.msHidden || document.visibilityState === "hidden";
                const hasNoFocus = !document.hasFocus();
                const isInactive = (now - lastActivityTime) > 10000; // 10秒以上操作なし（さらに短縮）
                
                // Windows Chrome対策: より積極的にオフライン判定
                if (isHidden) {
                    // 非表示なら即オフライン（複数回確認）
                    ensureOfflineStatus();
                    setTimeout(() => ensureOfflineStatus(), 100);
                } else if (hasNoFocus) {
                    // フォーカスなしだけでもオフライン判定（Windows Chrome用）
                    ensureOfflineStatus();
                } else if (hasNoFocus && isInactive) {
                    // フォーカスなし + 10秒以上操作なし
                    ensureOfflineStatus();
                } else if (document.visibilityState === "visible" && document.hasFocus()) {
                    // 表示中 + フォーカスあり
                    ensureOnlineStatus();
                }
            }
        }, 3000); // 3秒ごとにチェック（さらに頻繁に）

    </script>
</body>
</html>
